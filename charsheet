<input type="radio" name="attr_sheettype" value="pc" class="toggle-pc" style="opacity: 0; position: absolute; z-index: -1;" checked>
<input type="radio" name="attr_sheettype" value="npc" class="toggle-npc" style="opacity: 0; position: absolute; z-index: -1;">
<div class="sheet-type-toggle">
    <label class="toggle-label">
        <input type="radio" name="attr_view_tab" value="pc" checked>
        <span>PC</span>
    </label>
    <label class="toggle-label">
        <input type="radio" name="attr_view_tab" value="npc">
        <span>NPC</span>
    </label>
</div>
<div class="pc-sheet">
    <div class="header-section">
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">Identity</h2>
            </div>
            <div class="identity-two-col">
                <!-- LEFT COLUMN: Portrait + Core Stats -->
                <div class="identity-left-col">
                    <div class="portrait-container">
                        <img name="attr_character_avatar" class="character-portrait">
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Character Name</label>
                        <input type="text" name="attr_character_name">
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Epithet</label>
                        <input type="text" name="attr_epithet">
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Species / Race</label>
                        <input type="text" name="attr_species">
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Class</label>
                        <select name="attr_class">
                            <option value="">-- Select --</option>
                            <option value="Warrior">Warrior</option>
                            <option value="Scout">Scout</option>
                            <option value="Berzerker">Berzerker</option>
                            <option value="Sentinel">Sentinel</option>
                            <option value="Assassin">Assassin</option>
                            <option value="Grappler">Grappler</option>
                            <option value="Beastmaster">Beastmaster</option>
                            <option value="Shapeshifter">Shapeshifter</option>
                            <option value="Physician">Physician</option>
                            <option value="Magician">Magician</option>
                            <option value="Mystic">Mystic</option>
                            <option value="Dilettante">Dilettante</option>
                            <option value="Diabolist">Diabolist</option>
                            <option value="Heirophant">Heirophant</option>
                            <option value="Chanter">Chanter</option>
                            <option value="Maledictor">Maledictor</option>
                            <option value="Tactician">Tactician</option>
                            <option value="Architect">Architect</option>
                        </select>
                        <input type="hidden" name="attr_hd" value="d8">
                        <input type="hidden" name="attr_damage_die" value="d6">
                        <input type="hidden" name="attr_damage_prog" value="per Level">
                    </div>
                    <div class="core-stats-row">
                        <div class="identity-field">
                            <label class="field-label">Lvl</label>
                            <input type="number" name="attr_level" value="1" min="1" max="10">
                        </div>
                        <div class="identity-field">
                            <label class="field-label">HD</label>
                            <span class="stat-display" name="attr_hd">d8</span>
                        </div>
                        <div class="identity-field">
                            <label class="field-label">Dmg</label>
                            <span class="stat-display" name="attr_damage_die">d6</span>
                        </div>
                        <div class="identity-field">
                            <label class="field-label">Prog.</label>
                            <span class="stat-display" name="attr_damage_prog">per Level</span>
                        </div>
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Noble (Stability) Action</label>
                        <span class="stat-display action-display" name="attr_noble_stability">—</span>
                        <input type="hidden" name="attr_noble_stability" value="—">
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Noble (Change) Action</label>
                        <span class="stat-display action-display" name="attr_noble_change">—</span>
                        <input type="hidden" name="attr_noble_change" value="—">
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Ignoble Action</label>
                        <span class="stat-display action-display" name="attr_ignoble">—</span>
                        <input type="hidden" name="attr_ignoble" value="—">
                    </div>
                </div>
                <!-- RIGHT COLUMN: Other Identity Info -->
                <div class="identity-right-col">
                    <div class="identity-row-details">
                        <div class="identity-field">
                            <label class="field-label">Background</label>
                            <input type="text" name="attr_background">
                        </div>
                        <div class="identity-field identity-small">
                            <label class="field-label">Age</label>
                            <input type="text" name="attr_age">
                        </div>
                        <div class="identity-field identity-small">
                            <label class="field-label">Height</label>
                            <input type="text" name="attr_height">
                        </div>
                        <div class="identity-field identity-small">
                            <label class="field-label">Weight</label>
                            <input type="text" name="attr_weight">
                        </div>
                        <div class="identity-field">
                            <label class="field-label">Languages</label>
                            <input type="text" name="attr_languages">
                        </div>
                    </div>
                    <!-- Hidden radios for deity-filtered aspects -->
                    <input type="radio" name="attr_deity_filter" value="hnalla" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="dra" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="karakan" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="chegarra" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="thumis" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="ketengku" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="avanthe" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="dilinala" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="belkhanu" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="qon" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="hruu" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="wuru" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="vimuhla" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="chiteng" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="ksarul" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="gruganu" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="dlamelish" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="hrihayal" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="sarku" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="durritlamish" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="pariahother" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="pariahbone" class="deity-filter-radio">
                    <input type="radio" name="attr_deity_filter" value="pariahone" class="deity-filter-radio">
                    <div class="identity-row-deity">
                        <div class="identity-field">
                            <label class="field-label">Deity</label>
                            <select name="attr_deity" class="deity-select">
                                <option value="">— Select Deity —</option>
                                <optgroup label="Stability">
                                    <option value="Hnálla">Hnálla</option>
                                    <option value="Drá">Drá</option>
                                    <option value="Karakán">Karakán</option>
                                    <option value="Chegárra">Chegárra</option>
                                    <option value="Thúmis">Thúmis</option>
                                    <option value="Keténgku">Keténgku</option>
                                    <option value="Avánthe">Avánthe</option>
                                    <option value="Dilinála">Dilinála</option>
                                    <option value="Belkhánu">Belkhánu</option>
                                    <option value="Qón">Qón</option>
                                </optgroup>
                                <optgroup label="Change">
                                    <option value="Hrü'ü">Hrü'ü</option>
                                    <option value="Wurú">Wurú</option>
                                    <option value="Vimúhla">Vimúhla</option>
                                    <option value="Chiténg">Chiténg</option>
                                    <option value="Ksárul">Ksárul</option>
                                    <option value="Grugánu">Grugánu</option>
                                    <option value="Dlamélish">Dlamélish</option>
                                    <option value="Hriháyal">Hriháyal</option>
                                    <option value="Sárku">Sárku</option>
                                    <option value="Durritlámish">Durritlámish</option>
                                </optgroup>
                                <optgroup label="Pariah">
                                    <option value="The Other One">The Other One</option>
                                    <option value="The Goddess of the Pale Bone">The Goddess of the Pale Bone</option>
                                    <option value="The One Who Is">The One Who Is</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="identity-field identity-aspect">
                            <label class="field-label">Aspect</label>
                            <div class="aspect-container">
                                <select name="attr_aspect" class="aspect-select aspect-none">
                                    <option value="">— Select Deity First —</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-hnalla">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Chiráshin Tuléngkoi (The Shining Sun)">Chiráshin Tuléngkoi (Shining Sun)</option>
                                    <option value="Markhóm (Master of Transcendent Contemplation)">Markhóm (Transcendent Contemplation)</option>
                                    <option value="The Adjustment Men (The Eighth Aspect)">The Adjustment Men (Eighth Aspect)</option>
                                    <option value="Parshálmokoi hi Elítlayal (Teller of Skeins)">Parshálmokoi (Teller of Skeins)</option>
                                    <option value="Néktulen (Eyes Fixed upon the Light)">Néktulen (Eyes upon the Light)</option>
                                    <option value="Baján Ke'ún (Guardian of the Imperium)">Baján Ke'ún (Guardian of Imperium)</option>
                                    <option value="Jérmochusùn (Illuminator of the Dark)">Jérmochusùn (Illuminator of Dark)</option>
                                    <option value="Méntukoi hiJér (Crown of Light)">Méntukoi hiJér (Crown of Light)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-dra">
                                    <option value="">— Select Aspect —</option>
                                    <option value="The Uncaring">The Uncaring</option>
                                    <option value="The Lumpy and Unkempt">The Lumpy and Unkempt</option>
                                    <option value="The Wandering Chanter">The Wandering Chanter</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-karakan">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Mikkáshu (Shield of Scarlet)">Mikkáshu (Shield of Scarlet)</option>
                                    <option value="Orkútai (City-Destroyer)">Orkútai (City-Destroyer)</option>
                                    <option value="Nagotái (The Upholder)">Nagotái (The Upholder)</option>
                                    <option value="Jajkúru (Victor of Ships)">Jajkúru (Victor of Ships)</option>
                                    <option value="Chayenggúr (Blade-Bearer)">Chayenggúr (Blade-Bearer)</option>
                                    <option value="Rayéshtu (Many Swords)">Rayéshtu (Many Swords)</option>
                                    <option value="Faishán (Pinnacle of Victory)">Faishán (Pinnacle of Victory)</option>
                                    <option value="Mórsa (Doom-Singer)">Mórsa (Doom-Singer)</option>
                                    <option value="Niyónu (Hand of Gold)">Niyónu (Hand of Gold)</option>
                                    <option value="Ajjón (Silver Helm)">Ajjón (Silver Helm)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-chegarra">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Hmára (Lady of Imperial Justice)">Hmára (Lady of Imperial Justice)</option>
                                    <option value="Qorushái (Holder of Tribunals)">Qorushái (Holder of Tribunals)</option>
                                    <option value="Mi'irésh (Celestial Merchant Marine)">Mi'irésh (Celestial Merchant Marine)</option>
                                    <option value="Hórgoma (His Most Brave)">Hórgoma (His Most Brave)</option>
                                    <option value="Ajnélqa (The Besieger)">Ajnélqa (The Besieger)</option>
                                    <option value="Ngísurra (Superior Marshal)">Ngísurra (Superior Marshal)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-thumis">
                                    <option value="">— Select Aspect —</option>
                                    <option value="So'ónkum (Victor Over Hehekáino)">So'ónkum (Victor Over Hehekáino)</option>
                                    <option value="Armésh (Jeweled Serpent)">Armésh (Jeweled Serpent)</option>
                                    <option value="Kakán (Guide of Many Heroes)">Kakán (Guide of Many Heroes)</option>
                                    <option value="Kànukolúm (Plotter of Courses)">Kànukolúm (Plotter of Courses)</option>
                                    <option value="Nrásh (The Eye, Observer)">Nrásh (The Eye, Observer)</option>
                                    <option value="Khálesh (The Decider)">Khálesh (The Decider)</option>
                                    <option value="Chokóth (The Messenger)">Chokóth (The Messenger)</option>
                                    <option value="Feshmu'ún (Tutor of Gods)">Feshmu'ún (Tutor of Gods)</option>
                                    <option value="Muór (Sage of Sages)">Muór (Sage of Sages)</option>
                                    <option value="Tyélu (She Who Guides)">Tyélu (She Who Guides)</option>
                                    <option value="Ferésh (Patron of Pearls)">Ferésh (Patron of Pearls)</option>
                                    <option value="Chuharém (The Diviner)">Chuharém (The Diviner)</option>
                                    <option value="Oóng (Viewer of Towers)">Oóng (Viewer of Towers)</option>
                                    <option value="Ne'élti (Knower of Joinings)">Ne'élti (Knower of Joinings)</option>
                                    <option value="Majér (The Maiden)">Majér (The Maiden)</option>
                                    <option value="Békh (Mysteries of Gods)">Békh (Mysteries of Gods)</option>
                                    <option value="A'akán (Alchemist of Gods)">A'akán (Alchemist of Gods)</option>
                                    <option value="Shénj (Eye of Wisdom)">Shénj (Eye of Wisdom)</option>
                                    <option value="Pohán (Sage of Lost Cities)">Pohán (Sage of Lost Cities)</option>
                                    <option value="Tolokkón (Patron of Aridáni)">Tolokkón (Patron of Aridáni)</option>
                                    <option value="Thekkúsa (The Artificer)">Thekkúsa (The Artificer)</option>
                                    <option value="Meshmúr (Molder of Flesh)">Meshmúr (Molder of Flesh)</option>
                                    <option value="Ethuví'ish (God of Clocks)">Ethuví'ish (God of Clocks)</option>
                                    <option value="Semwáse (Weight-keeper)">Semwáse (Weight-keeper)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-ketengku">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Vayatlanlé (Banisher of Tumors)">Vayatlanlé (Banisher of Tumors)</option>
                                    <option value="Guétl (Healer, Banisher of Poisons)">Guétl (Healer, Banisher of Poisons)</option>
                                    <option value="Ba'alán (Preserver of Sanity)">Ba'alán (Preserver of Sanity)</option>
                                    <option value="Shomóre (Ministers the Feminine)">Shomóre (Ministers the Feminine)</option>
                                    <option value="Thomútha (The Man-Lover)">Thomútha (The Man-Lover)</option>
                                    <option value="Qoqákh (Healer of the Deformed)">Qoqákh (Healer of the Deformed)</option>
                                    <option value="Tírekshen (of the Sweet Jaws)">Tírekshen (of the Sweet Jaws)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-avanthe">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Sikkuné (Consoler of Mourners)">Sikkuné (Consoler of Mourners)</option>
                                    <option value="Kátha (Warrior Maid)">Kátha (Warrior Maid)</option>
                                    <option value="Tahelé (Maid of Beauty)">Tahelé (Maid of Beauty)</option>
                                    <option value="E'éth (of the Rains)">E'éth (of the Rains)</option>
                                    <option value="Quyéla (She Who Fertilizes)">Quyéla (She Who Fertilizes)</option>
                                    <option value="Chraikála (Cares for Children)">Chraikála (Cares for Children)</option>
                                    <option value="Nikoné (Pillar of Purity)">Nikoné (Pillar of Purity)</option>
                                    <option value="Chikúna (The Ripener)">Chikúna (The Ripener)</option>
                                    <option value="Aoméla (The Maintainer)">Aoméla (The Maintainer)</option>
                                    <option value="Niluélde (Mistress of Air)">Niluélde (Mistress of Air)</option>
                                    <option value="Hlikársh (Master of Fire Demons)">Hlikársh (Master of Fire Demons)</option>
                                    <option value="Dedé (Master of Earth Spirits)">Dedé (Master of Earth Spirits)</option>
                                    <option value="Jelél (Goddess of Potence)">Jelél (Goddess of Potence)</option>
                                    <option value="Keréna (The Wind)">Keréna (The Wind)</option>
                                    <option value="Chorisánde (Guide of Fools)">Chorisánde (Guide of Fools)</option>
                                    <option value="Bolénde (Lord of Water Spirits)">Bolénde (Lord of Water Spirits)</option>
                                    <option value="Sunrudáya (The Young Bride)">Sunrudáya (The Young Bride)</option>
                                    <option value="Shaka'án (Curious Little Girl)">Shaka'án (Curious Little Girl)</option>
                                    <option value="Shuchéla (The Virgin)">Shuchéla (The Virgin)</option>
                                    <option value="Makórsa (Protectress of Trees)">Makórsa (Protectress of Trees)</option>
                                    <option value="Kshésa (Knower of Cycles)">Kshésa (Knower of Cycles)</option>
                                    <option value="Nyéles (The Wise)">Nyéles (The Wise)</option>
                                    <option value="Jogái (The Songstress)">Jogái (The Songstress)</option>
                                    <option value="Eluláiku (Purveyor of Alimentation)">Eluláiku (Purveyor of Alimentation)</option>
                                    <option value="Póndu (Keeper of Scales)">Póndu (Keeper of Scales)</option>
                                    <option value="Halél (Servitor of Forlorn)">Halél (Servitor of Forlorn)</option>
                                    <option value="Varému (Protector of Small)">Varému (Protector of Small)</option>
                                    <option value="Koruláinen (Giant Within Earth)">Koruláinen (Giant Within Earth)</option>
                                    <option value="Balmé (The Healer)">Balmé (The Healer)</option>
                                    <option value="Ngacháni (Patroness of Mothers)">Ngacháni (Patroness of Mothers)</option>
                                    <option value="Njévra (The Cold)">Njévra (The Cold)</option>
                                    <option value="Zerússa (The One of Roads)">Zerússa (The One of Roads)</option>
                                    <option value="Orodhún (Paragon of Allure)">Orodhún (Paragon of Allure)</option>
                                    <option value="Kandomél (Smooth Remembering)">Kandomél (Smooth Remembering)</option>
                                    <option value="Qalái (Maintainer of Cycles)">Qalái (Maintainer of Cycles)</option>
                                    <option value="Weltíga (Lady of Scrolls)">Weltíga (Lady of Scrolls)</option>
                                    <option value="Nionél (Patron of Fragrances)">Nionél (Patron of Fragrances)</option>
                                    <option value="Mékhis (Defender of Harmony)">Mékhis (Defender of Harmony)</option>
                                    <option value="Cháith (The Empress)">Cháith (The Empress)</option>
                                    <option value="Parnémmi (Basking Waterfall)">Parnémmi (Basking Waterfall)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-dilinala">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Teshúna (The Guardian)">Teshúna (The Guardian)</option>
                                    <option value="Milaléa (The Sister)">Milaléa (The Sister)</option>
                                    <option value="Mríko (The Advocate)">Mríko (The Advocate)</option>
                                    <option value="Ssáni (The Lover)">Ssáni (The Lover)</option>
                                    <option value="Eshátl (The Champion)">Eshátl (The Champion)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-belkhanu">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Mrisó (Knower of Planes)">Mrisó (Knower of Planes)</option>
                                    <option value="Knower of the Paradises">Knower of the Paradises</option>
                                    <option value="Tronúa (Companion of Grieving)">Tronúa (Companion of Grieving)</option>
                                    <option value="Konchékme (Guide to Teretané)">Konchékme (Guide to Teretané)</option>
                                    <option value="Aldeyá (The Embalmer)">Aldeyá (The Embalmer)</option>
                                    <option value="Hettáshte (The Ferryman)">Hettáshte (The Ferryman)</option>
                                    <option value="Mórskodel (Mover of Dead Souls)">Mórskodel (Mover of Dead Souls)</option>
                                    <option value="Hayékka (Cartographer of Planes)">Hayékka (Cartographer of Planes)</option>
                                    <option value="Doluél (Guardian of Tombs)">Doluél (Guardian of Tombs)</option>
                                    <option value="Nentánte (The Far-Voyager)">Nentánte (The Far-Voyager)</option>
                                    <option value="The Saffron Wisp Maiden">The Saffron Wisp Maiden</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-qon">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Améreth (Transcends Death)">Améreth (Transcends Death)</option>
                                    <option value="Masséfa (Twelve-Legged Beast)">Masséfa (Twelve-Legged Beast)</option>
                                    <option value="Nakhesú (Guide of Lost Below)">Nakhesú (Guide of Lost Below)</option>
                                    <option value="Qazór (Flies Beyond Pylons)">Qazór (Flies Beyond Pylons)</option>
                                    <option value="Shinuéth (Unexpected Guardian)">Shinuéth (Unexpected Guardian)</option>
                                    <option value="Urádz (Wielder of Mace)">Urádz (Wielder of Mace)</option>
                                    <option value="Huróth (Watcher at Gate)">Huróth (Watcher at Gate)</option>
                                    <option value="Nekkudlákte (Sees the Paths)">Nekkudlákte (Sees the Paths)</option>
                                    <option value="Sengélu (The Ascetic)">Sengélu (The Ascetic)</option>
                                    <option value="Janásh (Smiter of the Gone)">Janásh (Smiter of the Gone)</option>
                                    <option value="Unúqa (Sage in Golden Robes)">Unúqa (Sage in Golden Robes)</option>
                                    <option value="Ta'ésh (The Illuminated One)">Ta'ésh (The Illuminated One)</option>
                                    <option value="Ndájja (The Long-Forgotten)">Ndájja (The Long-Forgotten)</option>
                                    <option value="Paréva (Gentle One of Sorrows)">Paréva (Gentle One of Sorrows)</option>
                                    <option value="Enushú (The Embalmer)">Enushú (The Embalmer)</option>
                                    <option value="Malán (The Immortal Path)">Malán (The Immortal Path)</option>
                                    <option value="Damádh (The Mighty)">Damádh (The Mighty)</option>
                                    <option value="Nggálba (The Sentinel)">Nggálba (The Sentinel)</option>
                                    <option value="Warghán (Light Behind Light)">Warghán (Light Behind Light)</option>
                                    <option value="Hekkél (Descender of Steps)">Hekkél (Descender of Steps)</option>
                                    <option value="Fashésh (God of Dead Cities)">Fashésh (God of Dead Cities)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-hruu">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Gyánu (Twenty-Five-Headed Demon)">Gyánu (Twenty-Five-Headed Demon)</option>
                                    <option value="Kaishmá (Lord of Deep Purple Dark)">Kaishmá (Lord of Deep Purple Dark)</option>
                                    <option value="Ordunásh (The Other One)">Ordunásh (The Other One)</option>
                                    <option value="Pémesh Tashqá (Cloud-Maker)">Pémesh Tashqá (Cloud-Maker)</option>
                                    <option value="Ngél (Dreamer of Transformations)">Ngél (Dreamer of Transformations)</option>
                                    <option value="Mitlán hiTiúniyal (Cat God)">Mitlán hiTiúniyal (Cat God)</option>
                                    <option value="The Black Old One">The Black Old One</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-wuru">
                                    <option value="">— Select Aspect —</option>
                                    <option value="M'chét Kanggé (Wanderer of Black)">M'chét Kanggé (Wanderer of Black)</option>
                                    <option value="Siunéth (Pleasant One of Mazes)">Siunéth (Pleasant One of Mazes)</option>
                                    <option value="Neshkéth (Old Crazy One)">Neshkéth (Old Crazy One)</option>
                                    <option value="Chiú Knésh (Sentinel of Caverns)">Chiú Knésh (Sentinel of Caverns)</option>
                                    <option value="Diéllunak (Bleak Goddess of Changes)">Diéllunak (Bleak Goddess of Changes)</option>
                                    <option value="Semúnu (Takes No Prisoners)">Semúnu (Takes No Prisoners)</option>
                                    <option value="Tikkúththu (Quintessential Guardian)">Tikkúththu (Quintessential Guardian)</option>
                                    <option value="Mkt'káne (Knower of Legends)">Mkt'káne (Knower of Legends)</option>
                                    <option value="Mekhmués (The Finder)">Mekhmués (The Finder)</option>
                                    <option value="Menwási (Master of Ténturen Song)">Menwási (Master of Ténturen Song)</option>
                                    <option value="Teshtesh (The Wrathful)">Teshtesh (The Wrathful)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-vimuhla">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Jmár (Lord of Flame)">Jmár (Lord of Flame)</option>
                                    <option value="Pa'lákh (Swath of Red)">Pa'lákh (Swath of Red)</option>
                                    <option value="Methqázh (Burning from Afar)">Methqázh (Burning from Afar)</option>
                                    <option value="Dumúggash (Spirit of Battle)">Dumúggash (Spirit of Battle)</option>
                                    <option value="Valédh (The Flayer)">Valédh (The Flayer)</option>
                                    <option value="Dikkómtla (Blazing Trident)">Dikkómtla (Blazing Trident)</option>
                                    <option value="Menuméng (Dark Flame)">Menuméng (Dark Flame)</option>
                                    <option value="Pùrukasái (Delights in Explosions)">Pùrukasái (Delights in Explosions)</option>
                                    <option value="Korogách (The Defender)">Korogách (The Defender)</option>
                                    <option value="Nmén (Drinker of Sacrifices)">Nmén (Drinker of Sacrifices)</option>
                                    <option value="Chahich'úr (The Preparer)">Chahich'úr (The Preparer)</option>
                                    <option value="Távastu (Bright Serpent)">Távastu (Bright Serpent)</option>
                                    <option value="Thájiran (Crucifier of Bandits)">Thájiran (Crucifier of Bandits)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-chiteng">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Marghél (The Burner)">Marghél (The Burner)</option>
                                    <option value="Sadhúa (The Torturer)">Sadhúa (The Torturer)</option>
                                    <option value="Pokhótl (Monstrous Toad)">Pokhótl (Monstrous Toad)</option>
                                    <option value="Ninormé (Orange Light of Paradise)">Ninormé (Orange Light of Paradise)</option>
                                    <option value="Biyü (The Inextinguishable)">Biyü (The Inextinguishable)</option>
                                    <option value="Pirágh (Harbinger of Scarlet Doom)">Pirágh (Harbinger of Scarlet Doom)</option>
                                    <option value="Imósh (Lord of Ashes)">Imósh (Lord of Ashes)</option>
                                    <option value="Neé (Warden of Third Way)">Neé (Warden of Third Way)</option>
                                    <option value="Akhádz (He Who Rises)">Akhádz (He Who Rises)</option>
                                    <option value="Metlákh (Glove of Fire)">Metlákh (Glove of Fire)</option>
                                    <option value="Zhahlánin (Hard Sister)">Zhahlánin (Hard Sister)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-ksarul">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Chópruna (Dweller in Shadow)">Chópruna (Dweller in Shadow)</option>
                                    <option value="Te'ekúna (Finder of Way Below)">Te'ekúna (Finder of Way Below)</option>
                                    <option value="Ey'ún (Knower of Skills)">Ey'ún (Knower of Skills)</option>
                                    <option value="Gorrúgu (Master of Black)">Gorrúgu (Master of Black)</option>
                                    <option value="Mentutékka (Dark Forest God)">Mentutékka (Dark Forest God)</option>
                                    <option value="Horókkoi Ghurúlmo (Gecko God)">Horókkoi Ghurúlmo (Gecko God)</option>
                                    <option value="Nankhétiu (The Eager)">Nankhétiu (The Eager)</option>
                                    <option value="Géthu (Patron of Lakes)">Géthu (Patron of Lakes)</option>
                                    <option value="Nlülu (The Rigger)">Nlülu (The Rigger)</option>
                                    <option value="Tlíra (The Early Morning)">Tlíra (The Early Morning)</option>
                                    <option value="Tánti'iki (Goddess of Blazing Hearth)">Tánti'iki (Goddess of Blazing Hearth)</option>
                                    <option value="Prince of Sticks and Straws">Prince of Sticks and Straws</option>
                                    <option value="Dark Side of Many Planets">Dark Side of Many Planets</option>
                                    <option value="Ge'én (Demon Lord Who Eats All)">Ge'én (Demon Lord Who Eats All)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-gruganu">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Nisház (Emperor of Tombs)">Nisház (Emperor of Tombs)</option>
                                    <option value="Mehlé (Protects Fools)">Mehlé (Protects Fools)</option>
                                    <option value="Damáris (Lovely Guide)">Damáris (Lovely Guide)</option>
                                    <option value="Mo'óth (Breathtaking One)">Mo'óth (Breathtaking One)</option>
                                    <option value="Vyér (Guide of White Staircase)">Vyér (Guide of White Staircase)</option>
                                    <option value="Ókh (Warder of Devices)">Ókh (Warder of Devices)</option>
                                    <option value="Cháshiq (Whisperer of Spells)">Cháshiq (Whisperer of Spells)</option>
                                    <option value="Tekóth Dmúnu (Opener of Gates)">Tekóth Dmúnu (Opener of Gates)</option>
                                    <option value="Ghóruq Dzéè (Great Terrible Fungus)">Ghóruq Dzéè (Great Terrible Fungus)</option>
                                    <option value="Akhunóm (Sword-Bearer)">Akhunóm (Sword-Bearer)</option>
                                    <option value="Mbéth (He Who Returns)">Mbéth (He Who Returns)</option>
                                    <option value="Khájju (One Who Yearns)">Khájju (One Who Yearns)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-dlamelish">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Arko'éla (Lady of Drink)">Arko'éla (Lady of Drink)</option>
                                    <option value="Meshmúra (Divergent Skeins)">Meshmúra (Divergent Skeins)</option>
                                    <option value="Vioséna (Pleasures of Fragrance)">Vioséna (Pleasures of Fragrance)</option>
                                    <option value="Nitósa (Stirring Image)">Nitósa (Stirring Image)</option>
                                    <option value="Teshkána (The Musician)">Teshkána (The Musician)</option>
                                    <option value="Shu'uré (Grand Exhilaration)">Shu'uré (Grand Exhilaration)</option>
                                    <option value="Nisimáya (Well of Virile Waters)">Nisimáya (Well of Virile Waters)</option>
                                    <option value="Moróva (Aspect of Eating)">Moróva (Aspect of Eating)</option>
                                    <option value="Mrikáya (Pleasure in Battle)">Mrikáya (Pleasure in Battle)</option>
                                    <option value="Góriku (The Gourmet)">Góriku (The Gourmet)</option>
                                    <option value="Ma'asha (Ecstatic Union)">Ma'asha (Ecstatic Union)</option>
                                    <option value="Pashélla (Sensuous Beauty)">Pashélla (Sensuous Beauty)</option>
                                    <option value="Qodhúr (The Potent One)">Qodhúr (The Potent One)</option>
                                    <option value="Dletára (Reflected Pleasures)">Dletára (Reflected Pleasures)</option>
                                    <option value="Tlakéla (Pleasing Powders)">Tlakéla (Pleasing Powders)</option>
                                    <option value="Choyá (Lascivious Music)">Choyá (Lascivious Music)</option>
                                    <option value="Med'dá (Ultimate Now)">Med'dá (Ultimate Now)</option>
                                    <option value="Morótha (The Restorer)">Morótha (The Restorer)</option>
                                    <option value="Snarél (Enhanced Beauty)">Snarél (Enhanced Beauty)</option>
                                    <option value="Shoén (Pleasing Illusions)">Shoén (Pleasing Illusions)</option>
                                    <option value="Thiálakoi Horókin (Maiden on Green Moon)">Thiálakoi Horókin (Maiden on Green Moon)</option>
                                    <option value="Pa'íya (Drinks Substance of Men)">Pa'íya (Drinks Substance of Men)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-hrihayal">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Niyunén (Unlooked-For Wealth)">Niyunén (Unlooked-For Wealth)</option>
                                    <option value="Aládh (Dancer of Temptation)">Aládh (Dancer of Temptation)</option>
                                    <option value="Shóhla (She Who Lusts)">Shóhla (She Who Lusts)</option>
                                    <option value="Keyél (The Songstress)">Keyél (The Songstress)</option>
                                    <option value="Chío (Most Unspeakable Act)">Chío (Most Unspeakable Act)</option>
                                    <option value="Balóth (The Glutton)">Balóth (The Glutton)</option>
                                    <option value="Onkané (Lover of Self)">Onkané (Lover of Self)</option>
                                    <option value="Beletkané (Lover of Opposite)">Beletkané (Lover of Opposite)</option>
                                    <option value="Iyéth (Man Who Loves Men)">Iyéth (Man Who Loves Men)</option>
                                    <option value="Onuqáimu (Woman Who Loves Woman)">Onuqáimu (Woman Who Loves Woman)</option>
                                    <option value="Mornén (Drunken Lady)">Mornén (Drunken Lady)</option>
                                    <option value="Kilitána (Delight in Pain)">Kilitána (Delight in Pain)</option>
                                    <option value="Hajjána (Delight in Others' Pain)">Hajjána (Delight in Others' Pain)</option>
                                    <option value="Lusánesh (Patron of Bestiality)">Lusánesh (Patron of Bestiality)</option>
                                    <option value="Okókh (The Coprophage)">Okókh (The Coprophage)</option>
                                    <option value="Eshqúra (Lover of All Things)">Eshqúra (Lover of All Things)</option>
                                    <option value="Virála (Singer of Orgiasts)">Virála (Singer of Orgiasts)</option>
                                    <option value="Chemésh (Lady of Xenophiles)">Chemésh (Lady of Xenophiles)</option>
                                    <option value="Nukhér (Patroness of Necrophiles)">Nukhér (Patroness of Necrophiles)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-sarku">
                                    <option value="">— Select Aspect —</option>
                                    <option value="The Vermin Lord">The Vermin Lord</option>
                                    <option value="Chmúr (Hands of Grey)">Chmúr (Hands of Grey)</option>
                                    <option value="Siyenágga (Wanderer of Tombs)">Siyenágga (Wanderer of Tombs)</option>
                                    <option value="Ha'ótl (Tattered Shroud)">Ha'ótl (Tattered Shroud)</option>
                                    <option value="Ku'ún (Corpse-Lord)">Ku'ún (Corpse-Lord)</option>
                                    <option value="Dijátl (Copper-Clawed)">Dijátl (Copper-Clawed)</option>
                                    <option value="Akhmér (Visage in Mist)">Akhmér (Visage in Mist)</option>
                                    <option value="Naupál (Blackened Lips)">Naupál (Blackened Lips)</option>
                                    <option value="Zaidza (Princess of Mold)">Zaidza (Princess of Mold)</option>
                                    <option value="Awéth (Paladin of Skulls)">Awéth (Paladin of Skulls)</option>
                                    <option value="Mshéqw (Bloated One of Sea)">Mshéqw (Bloated One of Sea)</option>
                                    <option value="Mrúgga (Angel of Darkness)">Mrúgga (Angel of Darkness)</option>
                                    <option value="Véshkuru (Lord of Copper)">Véshkuru (Lord of Copper)</option>
                                    <option value="Batha'ák (Eye of Eternity)">Batha'ák (Eye of Eternity)</option>
                                    <option value="Njéng (Spy of Sárku)">Njéng (Spy of Sárku)</option>
                                    <option value="Albél (The Pursuer)">Albél (The Pursuer)</option>
                                    <option value="Chágh Umér (Intellect of Planes)">Chágh Umér (Intellect of Planes)</option>
                                    <option value="Óghur (Restorer of Bones)">Óghur (Restorer of Bones)</option>
                                    <option value="Ésh Akté (Brings Back the Gone)">Ésh Akté (Brings Back the Gone)</option>
                                    <option value="Vína Néleth (Returner of Apostates)">Vína Néleth (Returner of Apostates)</option>
                                    <option value="Kóschi (The Fermenter)">Kóschi (The Fermenter)</option>
                                    <option value="Hmwú'ukha (The Belled One)">Hmwú'ukha (The Belled One)</option>
                                    <option value="The Worm of Many Nights">The Worm of Many Nights</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-durritlamish">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Hoggách (Impossible Stench)">Hoggách (Impossible Stench)</option>
                                    <option value="Nri'íkh (General of Undead)">Nri'íkh (General of Undead)</option>
                                    <option value="Bázh Akhár (Master of Putrescence)">Bázh Akhár (Master of Putrescence)</option>
                                    <option value="Adhém (The Scalped One)">Adhém (The Scalped One)</option>
                                    <option value="Mwákh (The Gibbering)">Mwákh (The Gibbering)</option>
                                    <option value="Nekhtávra (The Bloated)">Nekhtávra (The Bloated)</option>
                                    <option value="Dókh Omér (The Hand)">Dókh Omér (The Hand)</option>
                                    <option value="Ghenésh (Eternal Pustule)">Ghenésh (Eternal Pustule)</option>
                                    <option value="Jewéth (The Skinless)">Jewéth (The Skinless)</option>
                                    <option value="Ghotné (Black Snarling Snout)">Ghotné (Black Snarling Snout)</option>
                                    <option value="Nrgé Cháth (Putrescent Filth)">Nrgé Cháth (Putrescent Filth)</option>
                                    <option value="Pakhán (Unconquerable Mold)">Pakhán (Unconquerable Mold)</option>
                                    <option value="Roqáv (The Web-Spinner)">Roqáv (The Web-Spinner)</option>
                                    <option value="Chágh (The Rotten)">Chágh (The Rotten)</option>
                                    <option value="Khóm Dlá (Master of Beetles)">Khóm Dlá (Master of Beetles)</option>
                                    <option value="Orghésh (The Unseeable)">Orghésh (The Unseeable)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-pariahother">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Aíkh Amóm (Outermost Wall of the Blue Room)">Aíkh Amóm (Outermost Wall of Blue Room)</option>
                                    <option value="Nmédz (The Mind Prison)">Nmédz (The Mind Prison)</option>
                                    <option value="The Aberration">The Aberration</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-pariahbone">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Mshékh (She Who Must Not Be Named)">Mshékh (She Who Must Not Be Named)</option>
                                    <option value="Kúù Tép (The Thief of Thought)">Kúù Tép (The Thief of Thought)</option>
                                </select>
                                <select name="attr_aspect" class="aspect-select aspect-pariahone">
                                    <option value="">— Select Aspect —</option>
                                    <option value="Aíkh Halóm (The Darkness Below the World)">Aíkh Halóm (Darkness Below the World)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="identity-field">
                        <label class="field-label">Reputation</label>
                        <div class="reputation-selector">
                            <label>
                                <input type="radio" name="attr_reputation" value="impeccable">
                                <span class="rep-impeccable">Impeccable</span>
                            </label>
                            <label>
                                <input type="radio" name="attr_reputation" value="noble">
                                <span class="rep-noble">Noble</span>
                            </label>
                            <label>
                                <input type="radio" name="attr_reputation" value="proper" checked>
                                <span class="rep-proper">Proper</span>
                            </label>
                            <label>
                                <input type="radio" name="attr_reputation" value="ignoble">
                                <span class="rep-ignoble">Ignoble</span>
                            </label>
                            <label>
                                <input type="radio" name="attr_reputation" value="shameless">
                                <span class="rep-shameless">Shameless</span>
                            </label>
                        </div>
                        <div class="reputation-dice-ref">
                            <span class="rep-climb">↑ Climb: Ud8 (Ud10 from Shameless)</span>
                            <span class="rep-fall">↓ Fall: Ud4</span>
                        </div>
                    </div>
                    <div class="identity-field">
                        <div class="reputation-effect-header">
                            <label class="field-label">Reputation Effect</label>
                            <button type="roll" name="roll_reputation" class="btn-rep-roll" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Reputation Roll}} {{roll=[[?{Act Type|Noble Act (climbing),@{reputation_die_up}|Ignoble Act (falling),1d4}]]}} {{description=?{Act Type|Noble Act (climbing),Climbing toward nobility|Ignoble Act (falling),Falling toward shame}. **1-2 = Reputation shifts!**}}">Reputation Roll</button>
                        </div>
                        <span class="stat-display reputation-effect" name="attr_reputation_effect">You are unremarkable. People treat you fairly but without special regard.</span>
                        <input type="hidden" name="attr_reputation_effect" value="You are unremarkable. People treat you fairly but without special regard.">
                        <input type="hidden" name="attr_reputation_die_up" value="1d8">
                    </div>
                    <div class="identity-field identity-hook">
                        <label class="field-label">Hook</label>
                        <textarea name="attr_character_hook"></textarea>
                    </div>
                    <div class="identity-field identity-hook">
                        <label class="field-label">Current Interest</label>
                        <textarea name="attr_current_interest"></textarea>
                    </div>
                </div>
            </div>
            <div class="identity-separator"></div>
        </div>
    </div>
    <div class="sheet-row-2col">
        <div class="col-panel">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Attributes</h2>
                </div>
                <input type="hidden" name="attr_str_state" value="normal">
                <input type="hidden" name="attr_dex_state" value="normal">
                <input type="hidden" name="attr_con_state" value="normal">
                <input type="hidden" name="attr_int_state" value="normal">
                <input type="hidden" name="attr_wis_state" value="normal">
                <input type="hidden" name="attr_cha_state" value="normal">
                <div class="attributes-grid">
                    <div class="attribute-block str-block">
                        <span class="attribute-name">STR</span>
                        <input type="number" name="attr_str" value="10" class="attribute-value">
                        <button type="roll" name="roll_str" class="attribute-roll" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Strength Test}} {{target=[[@{str}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{type=attribute}}">Roll</button>
                    </div>
                    <div class="attribute-block dex-block">
                        <span class="attribute-name">DEX</span>
                        <input type="number" name="attr_dex" value="10" class="attribute-value">
                        <button type="roll" name="roll_dex" class="attribute-roll" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Dexterity Test}} {{target=[[@{dex}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{type=attribute}}">Roll</button>
                    </div>
                    <div class="attribute-block con-block">
                        <span class="attribute-name">CON</span>
                        <input type="number" name="attr_con" value="10" class="attribute-value">
                        <button type="roll" name="roll_con" class="attribute-roll" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Constitution Test}} {{target=[[@{con}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{type=attribute}}">Roll</button>
                    </div>
                    <div class="attribute-block int-block">
                        <span class="attribute-name">INT</span>
                        <input type="number" name="attr_int" value="10" class="attribute-value">
                        <button type="roll" name="roll_int" class="attribute-roll" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Intelligence Test}} {{target=[[@{int}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{type=attribute}}">Roll</button>
                    </div>
                    <div class="attribute-block wis-block">
                        <span class="attribute-name">WIS</span>
                        <input type="number" name="attr_wis" value="10" class="attribute-value">
                        <button type="roll" name="roll_wis" class="attribute-roll" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Wisdom Test}} {{target=[[@{wis}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{type=attribute}}">Roll</button>
                    </div>
                    <div class="attribute-block cha-block">
                        <span class="attribute-name">CHA</span>
                        <input type="number" name="attr_cha" value="10" class="attribute-value">
                        <button type="roll" name="roll_cha" class="attribute-roll" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Charisma Test}} {{target=[[@{cha}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{type=attribute}}">Roll</button>
                    </div>
                </div>
                <input type="hidden" name="attr_move_state" value="normal">
                <div class="move-init-section">
                    <h3 class="subsection-header">Movement & Initiative</h3>
                    <div class="move-init-grid">
                        <div class="move-block">
                            <label class="field-label">Movement</label>
                            <input type="text" name="attr_movement_speed">
                        </div>
                        <div class="init-block">
                            <label class="field-label">Init. Bonus</label>
                            <input type="number" name="attr_initiative_bonus" value="0">
                        </div>
                        <div class="init-roll">
                            <button type="action" name="act_initiative" class="btn-small">Roll</button>
                            <button type="roll" name="roll_init_before" class="btn-small" style="background:#6b8e6b;font-size:9px;padding:2px 5px;"
                                value="[[1 &{tracker}]]">Before</button>
                            <button type="roll" name="roll_init_after" class="btn-small" style="background:#a65d57;font-size:9px;padding:2px 5px;"
                                value="[[3 &{tracker}]]">After</button>
                        </div>
                    </div>
                    <div class="status-effect-display">
                        <span name="attr_movement_status_text"></span>
                    </div>
                </div>
                <div class="attr-footer-split">
                    <div class="inspiration-col">
                        <label class="field-label">Inspiration</label>
                        <label class="inspiration-toggle">
                            <input type="checkbox" name="attr_inspiration" value="1">
                            <span class="inspiration-icon">✦</span>
                        </label>
                    </div>
                    <div class="doom-col">
                        <label class="field-label">Doom Die</label>
                        <div class="doom-selector">
                            <label>
                                <input type="radio" name="attr_doom_die" value="0" checked>
                                <span>—</span>
                            </label>
                            <label>
                                <input type="radio" name="attr_doom_die" value="d4">
                                <span>Ud4</span>
                            </label>
                            <label>
                                <input type="radio" name="attr_doom_die" value="d6">
                                <span>Ud6</span>
                            </label>
                            <label>
                                <input type="radio" name="attr_doom_die" value="d8">
                                <span>Ud8</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Weapons</h2>
                </div>
                <input type="hidden" name="attr_weapon1_target" value="10">
                <input type="hidden" name="attr_weapon2_target" value="10">
                <input type="hidden" name="attr_weapon3_target" value="10">
                <div style="display: grid; grid-template-columns: 3fr 55px 40px 110px 45px; gap: 6px; margin-bottom: 6px;">
                    <span class="weapons-header">Weapon</span>
                    <span class="weapons-header">Range</span>
                    <span class="weapons-header">Stat</span>
                    <span class="weapons-header">Dmg + Bonus</span>
                    <span class="weapons-header">Attack</span>
                </div>
                <div class="weapon-block" style="padding-bottom: 6px; margin-bottom: 6px; border-bottom: 1px dashed #4a5568;">
                    <div style="display: grid; grid-template-columns: 3fr 55px 40px 110px 45px; gap: 6px; align-items: center;">
                        <input type="text" name="attr_weapon1_name" placeholder="Weapon name">
                        <span class="weapon-range" name="attr_weapon1_range_display">Close 5'</span>
                        <input type="hidden" name="attr_weapon1_stat" value="str">
                        <span class="weapon-stat-display" name="attr_weapon1_stat_display">STR</span>
                        <div class="weapon-damage-group">
                            <span class="weapon-dmg-display" name="attr_damage_display">Pool: 1d6</span>
                            <span class="weapon-dmg-plus">+</span>
                            <input type="text" name="attr_weapon1_bonus" value="0" class="weapon-bonus-input">
                        </div>
                        <button type="action" name="act_weapon1_attack" class="btn-small">Hit!</button>
                    </div>
                    <div class="weapon-properties">
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_large"><span>Large</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_dual"><span>Dual</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_light"><span>Light</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_thrown"><span>Thrown</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_ranged"><span>Ranged</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_reach"><span>Reach</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_steel"><span>Steel</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_keen"><span>Keen</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_magic"><span>Magic</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_holy"><span>Holy</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_silver"><span>Silver</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon1_master"><span>Master</span></label>
                    </div>
                    <div style="margin-top: 4px;">
                        <input type="text" name="attr_weapon1_notes" placeholder="Other properties" style="width: 100%; font-size: 11px; padding: 4px 8px; background: rgba(26, 26, 46, 0.6); border: 1px dashed #4a5568;">
                    </div>
                </div>
                <div class="weapon-block" style="padding-bottom: 6px; margin-bottom: 6px; border-bottom: 1px dashed #4a5568;">
                    <div style="display: grid; grid-template-columns: 3fr 55px 40px 110px 45px; gap: 6px; align-items: center;">
                        <input type="text" name="attr_weapon2_name" placeholder="Weapon name">
                        <span class="weapon-range" name="attr_weapon2_range_display">Close 5'</span>
                        <input type="hidden" name="attr_weapon2_stat" value="str">
                        <span class="weapon-stat-display" name="attr_weapon2_stat_display">STR</span>
                        <div class="weapon-damage-group">
                            <span class="weapon-dmg-display" name="attr_damage_display">Pool: 1d6</span>
                            <span class="weapon-dmg-plus">+</span>
                            <input type="text" name="attr_weapon2_bonus" value="0" class="weapon-bonus-input">
                        </div>
                        <button type="action" name="act_weapon2_attack" class="btn-small">Hit!</button>
                    </div>
                    <div class="weapon-properties">
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_large"><span>Large</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_dual"><span>Dual</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_light"><span>Light</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_thrown"><span>Thrown</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_ranged"><span>Ranged</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_reach"><span>Reach</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_steel"><span>Steel</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_keen"><span>Keen</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_magic"><span>Magic</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_holy"><span>Holy</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_silver"><span>Silver</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon2_master"><span>Master</span></label>
                    </div>
                    <div style="margin-top: 4px;">
                        <input type="text" name="attr_weapon2_notes" placeholder="Other properties" style="width: 100%; font-size: 11px; padding: 4px 8px; background: rgba(26, 26, 46, 0.6); border: 1px dashed #4a5568;">
                    </div>
                </div>
                <div class="weapon-block">
                    <div style="display: grid; grid-template-columns: 3fr 55px 40px 110px 45px; gap: 6px; align-items: center;">
                        <input type="text" name="attr_weapon3_name" placeholder="Weapon name">
                        <span class="weapon-range" name="attr_weapon3_range_display">Close 5'</span>
                        <input type="hidden" name="attr_weapon3_stat" value="str">
                        <span class="weapon-stat-display" name="attr_weapon3_stat_display">STR</span>
                        <div class="weapon-damage-group">
                            <span class="weapon-dmg-display" name="attr_damage_display">Pool: 1d6</span>
                            <span class="weapon-dmg-plus">+</span>
                            <input type="text" name="attr_weapon3_bonus" value="0" class="weapon-bonus-input">
                        </div>
                        <button type="action" name="act_weapon3_attack" class="btn-small">Hit!</button>
                    </div>
                    <div class="weapon-properties">
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_large"><span>Large</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_dual"><span>Dual</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_light"><span>Light</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_thrown"><span>Thrown</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_ranged"><span>Ranged</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_reach"><span>Reach</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_steel"><span>Steel</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_keen"><span>Keen</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_magic"><span>Magic</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_holy"><span>Holy</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_silver"><span>Silver</span></label>
                        <label class="weapon-prop"><input type="checkbox" name="attr_weapon3_master"><span>Master</span></label>
                    </div>
                    <div style="margin-top: 4px;">
                        <input type="text" name="attr_weapon3_notes" placeholder="Other properties" style="width: 100%; font-size: 11px; padding: 4px 8px; background: rgba(26, 26, 46, 0.6); border: 1px dashed #4a5568;">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 6px;">
                    <button type="roll" name="roll_extra_damage" class="btn-small" value="&{template:birdhack} {{name=Extra Damage}} {{damage=[[?{Extra Damage Dice (e.g. 1d6 fire)|1d6}cs0cf0]]}}">Roll Extra Damage</button>
                </div>
                <div style="text-align: center; margin-top: 10px; padding-top: 8px; border-top: 1px dashed #4a5568;">
                    <label class="mystic-toggle-label">
                        <input type="checkbox" name="attr_weapon_mystic_override" value="1">
                        <span>Mystic with Magical Weapon?</span>
                    </label>
                </div>
                <input type="hidden" name="attr_attack_state" value="normal">
                <div class="status-effect-display attack-status-display">
                    <span name="attr_attack_status_text"></span>
                </div>
            </div>
            <div class="panel">
                <input type="checkbox" name="attr_mystic_toggle" class="mystic-driver" value="1" style="display: none;">
                    <div class="panel-header">
                    <h2 class="panel-title">Attunements</h2>
                </div>
                <div class="attunements-grid">
                    <div class="attunement-header">
                        <span>Name</span>
                        <span>Slot / Lendee</span>
                        <span>Usage Die</span>
                    </div>
                    <div class="attunement-row"><input type="text" name="attr_attunement1_name"><input type="text" name="attr_attunement1_slot"><select name="attr_attunement1_ud"><option value="-">-</option><option value="Ud4">Ud4</option><option value="Ud6">Ud6</option><option value="Ud8">Ud8</option><option value="Ud10">Ud10</option><option value="Ud12">Ud12</option></select></div>
                    <div class="attunement-row"><input type="text" name="attr_attunement2_name"><input type="text" name="attr_attunement2_slot"><select name="attr_attunement2_ud"><option value="-">-</option><option value="Ud4">Ud4</option><option value="Ud6">Ud6</option><option value="Ud8">Ud8</option><option value="Ud10">Ud10</option><option value="Ud12">Ud12</option></select></div>
                    <div class="attunement-row"><input type="text" name="attr_attunement3_name"><input type="text" name="attr_attunement3_slot"><select name="attr_attunement3_ud"><option value="-">-</option><option value="Ud4">Ud4</option><option value="Ud6">Ud6</option><option value="Ud8">Ud8</option><option value="Ud10">Ud10</option><option value="Ud12">Ud12</option></select></div>
                    <div class="attunement-row"><input type="text" name="attr_attunement4_name"><input type="text" name="attr_attunement4_slot"><select name="attr_attunement4_ud"><option value="-">-</option><option value="Ud4">Ud4</option><option value="Ud6">Ud6</option><option value="Ud8">Ud8</option><option value="Ud10">Ud10</option><option value="Ud12">Ud12</option></select></div>
                    <div class="attunement-row mystic-only"><input type="text" name="attr_attunement5_name"><input type="text" name="attr_attunement5_slot"><select name="attr_attunement5_ud"><option value="-">-</option><option value="Ud4">Ud4</option><option value="Ud6">Ud6</option><option value="Ud8">Ud8</option><option value="Ud10">Ud10</option><option value="Ud12">Ud12</option></select></div>
                    <div class="attunement-row mystic-only"><input type="text" name="attr_attunement6_name"><input type="text" name="attr_attunement6_slot"><select name="attr_attunement6_ud"><option value="-">-</option><option value="Ud4">Ud4</option><option value="Ud6">Ud6</option><option value="Ud8">Ud8</option><option value="Ud10">Ud10</option><option value="Ud12">Ud12</option></select></div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <label class="mystic-toggle-label" style="cursor: pointer; font-size: 12px;">
                        <input type="checkbox" name="attr_mystic_toggle" value="1">
                        <span>Mystic?</span>
                    </label>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Institution</h2>
                </div>
                <div class="clan-grid">
                    <div class="identity-field">
                        <label class="field-label">Name</label>
                        <input type="text" name="attr_clan_name">
                    </div>
                    <div class="identity-field">
                        <label class="field-label">Function</label>
                        <input type="text" name="attr_clan_function">
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label class="field-label">Standing</label>
                    <div class="standing-selector">
                        <label>
                            <input type="radio" name="attr_standing_die" value="0">
                            <span class="standing-0">—</span>
                        </label>
                        <label>
                            <input type="radio" name="attr_standing_die" value="d4">
                            <span class="standing-d4">Ud4</span>
                        </label>
                        <label>
                            <input type="radio" name="attr_standing_die" value="d6">
                            <span class="standing-d6">Ud6</span>
                        </label>
                        <label>
                            <input type="radio" name="attr_standing_die" value="d8" checked>
                            <span class="standing-d8">Ud8</span>
                        </label>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label class="field-label">Duties</label>
                    <textarea name="attr_clan_duties" style="width: 100%; min-height: 60px; resize: vertical;"></textarea>
                </div>
                <div style="margin-top: 10px;">
                    <button type="action" name="act_clan_aid">Request Aid</button>
                </div>
            </div>
        </div>
        <div class="col-panel">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Hit Points</h2>
                </div>
                <div class="hp-container">
                    <div class="hp-block current">
                        <label class="field-label">Current</label>
                        <input type="number" name="attr_hp" value="0">
                    </div>
                    <span class="hp-divider">/</span>
                    <div class="hp-block">
                        <label class="field-label">Maximum</label>
                        <input type="number" name="attr_hp_max" value="0">
                    </div>
                    <div class="hp-block">
                        <label class="field-label">Temp</label>
                        <input type="number" name="attr_hp_temp" value="0">
                    </div>
                    <div class="rest-buttons">
                        <button type="action" name="act_short_rest" class="btn-small btn-success">Short (<span name="attr_rest_hd_short">1</span>)</button>
                        <button type="action" name="act_watch_rest" class="btn-small btn-success">Watch (<span name="attr_rest_hd_watch">1</span>)</button>
                        <button type="action" name="act_long_rest" class="btn-small btn-success">Long (<span name="attr_rest_hd_long">1</span>)</button>
                    </div>
                </div>
                <input type="hidden" name="attr_rest_hd_short" value="1">
                <input type="hidden" name="attr_rest_hd_watch" value="1">
                <input type="hidden" name="attr_rest_hd_long" value="1">
                <input type="hidden" name="attr_damage_display" value="Pool: 1d6">
                <input type="hidden" name="attr_hp_state" value="normal">
                <div class="status-effect-display hp-status-display">
                    <span name="attr_hp_status_text"></span>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Status Conditions</h2>
                </div>
                <div class="status-grid good">
                    <label class="status-check"><input type="checkbox" name="attr_status_empowered"><span>Empowered</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_hastened"><span>Hastened</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_mighty"><span>Mighty</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_nimble"><span>Nimble</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_vigorous"><span>Vigorous</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_lucid"><span>Lucid</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_resolute"><span>Resolute</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_majestic"><span>Majestic</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_unstoppable"><span>Unstoppable</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_vigilant"><span>Vigilant</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_warded"><span>Warded</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_shrouded"><span>Shrouded</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_regenerating"><span>Regenerating</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_ethereal"><span>Ethereal</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_flying"><span>Flying</span></label>
                </div>
                <hr class="status-divider">
                <div class="status-grid bad">
                    <label class="status-check"><input type="checkbox" name="attr_status_prone"><span>Prone</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_weakened"><span>Weakened</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_battered"><span>Battered</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_shaky"><span>Shaky</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_fevered"><span>Fevered</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_addled"><span>Addled</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_rattled"><span>Rattled</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_stench"><span>Stench</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_deafened"><span>Deafened</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_blinded"><span>Blinded</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_grappled"><span>Grappled</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_stuck"><span>Stuck</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_paralyzed"><span>Paralyzed</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_unconscious"><span>Unconscious</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_distracted"><span>Distracted</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_doomed"><span>Doomed</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_silenced"><span>Silenced</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_stunned"><span>Stunned</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_frightened"><span>Frightened</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_confused"><span>Confused</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_bewildered"><span>Bewildered</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_exhausted"><span>Exhausted</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_charmed"><span>Charmed</span></label>
                    <label class="status-check"><input type="checkbox" name="attr_status_bleeding"><span>Bleeding</span></label>
                </div>
            </div>
            <div class="panel armor-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Armor</h2>
                    <span class="panel-subtitle">Pool: <span name="attr_av_total">0</span></span>
                </div>
                 <input type="hidden" name="attr_ward_state" value="normal">
                 <!-- PC Damage Type States -->
                 <input type="hidden" name="attr_pc_dmg_bludgeoning" value="0">
                 <input type="hidden" name="attr_pc_dmg_slashing" value="0">
                 <input type="hidden" name="attr_pc_dmg_piercing" value="0">
                 <input type="hidden" name="attr_pc_dmg_fire" value="0">
                 <input type="hidden" name="attr_pc_dmg_cold" value="0">
                 <input type="hidden" name="attr_pc_dmg_lightning" value="0">
                 <input type="hidden" name="attr_pc_dmg_acid" value="0">
                 <input type="hidden" name="attr_pc_dmg_thunder" value="0">
                 <input type="hidden" name="attr_pc_dmg_force" value="0">
                 <input type="hidden" name="attr_pc_dmg_psychic" value="0">
                 <input type="hidden" name="attr_pc_dmg_necrotic" value="0">
                 <input type="hidden" name="attr_pc_dmg_radiant" value="0">
                 <input type="hidden" name="attr_pc_dmg_poison" value="0">

                 <!-- Ward Row (subtracts first, separate from armor pool) -->
                 <div class="ward-section">
                    <div class="ward-row-new">
                        <span class="ward-label">Ward</span>
                        <span class="ward-note">(Subtracts 1st)</span>
                        <input type="number" name="attr_ward_av_max" value="0" style="width: 40px;" title="Max Ward">
                        <div class="av-controls">
                            <button type="action" name="act_ward_minus" class="av-btn btn-danger">−</button>
                            <input type="number" name="attr_ward_av" value="0" class="av-value" readonly>
                            <button type="action" name="act_ward_plus" class="av-btn btn-success">+</button>
                        </div>
                    </div>
                 </div>

                 <!-- Equipment Section -->
                 <div class="armor-equipment">
                    <div class="armor-equip-header">
                        <span></span>
                        <span>Name</span>
                        <span>AV</span>
                    </div>
                    <div class="armor-equip-row">
                        <label class="armor-slot-label">Armor</label>
                        <input type="text" name="attr_armor_name">
                        <input type="number" name="attr_armor_av" value="0" title="Armor Value (pool size & repair target)">
                    </div>
                    <div class="armor-equip-row">
                        <label class="armor-slot-label">Helmet</label>
                        <input type="text" name="attr_helmet_name">
                        <input type="number" name="attr_helmet_dice" value="0" title="+Dice for repair rolls">
                    </div>
                    <div class="armor-equip-row">
                        <label class="armor-slot-label">Shield</label>
                        <input type="text" name="attr_shield_name">
                        <input type="number" name="attr_shield_dice" value="0" title="+Dice for repair rolls">
                    </div>
                 </div>

                 <!-- Dice Pool Section -->
                 <div class="armor-pool-section">
                    <div class="pool-stats">
                        <div class="pool-stat">
                            <label class="field-label">Pool</label>
                            <span name="attr_armor_pool_total" class="pool-value">0</span>
                        </div>
                        <div class="pool-stat">
                            <label class="field-label">Available</label>
                            <div class="av-controls">
                                <button type="action" name="act_pool_minus" class="av-btn btn-danger">−</button>
                                <input type="number" name="attr_armor_pool_available" value="0" class="av-value" readonly>
                                <button type="action" name="act_pool_plus" class="av-btn btn-success">+</button>
                            </div>
                        </div>
                        <div class="pool-stat">
                            <label class="field-label">Damaged</label>
                            <span name="attr_armor_pool_damaged" class="pool-damaged-value">0</span>
                        </div>
                        <div class="pool-stat">
                            <label class="field-label">Destroyed</label>
                            <span name="attr_armor_pool_destroyed" class="pool-destroyed-value">0</span>
                        </div>
                    </div>
                    <div class="pool-buttons">
                        <button type="action" name="act_break_armor" class="btn-small btn-danger">Break Armor Die</button>
                        <button type="action" name="act_repair_armor" class="btn-small">Repair</button>
                        <button type="action" name="act_settlement_repair" class="btn-small btn-success">Settlement Repair</button>
                    </div>
                 </div>
                
                <!-- Damage Type Grid -->
                <div class="pc-dmg-section">
                    <label class="field-label" style="font-size: 9px; margin-top: 10px; margin-bottom: 4px; display: block;">Resistances / Vulnerabilities / Immunities</label>
                    
                    <!-- Mundane Grid (3 wide) -->
                    <div class="pc-dmg-grid mundane-grid">
                        <button type="action" name="act_pc_toggle_bludgeoning" class="pc-dmg-btn" data-dmg="bludgeoning">Bludg.</button>
                        <button type="action" name="act_pc_toggle_slashing" class="pc-dmg-btn" data-dmg="slashing">Slash.</button>
                        <button type="action" name="act_pc_toggle_piercing" class="pc-dmg-btn" data-dmg="piercing">Pierce.</button>
                    </div>
                    
                    <hr class="pc-dmg-divider">
                    
                    <!-- Elemental Grid (5 wide, 2 rows) -->
                    <div class="pc-dmg-grid elemental-grid">
                        <button type="action" name="act_pc_toggle_fire" class="pc-dmg-btn" data-dmg="fire">Fire</button>
                        <button type="action" name="act_pc_toggle_cold" class="pc-dmg-btn" data-dmg="cold">Cold</button>
                        <button type="action" name="act_pc_toggle_lightning" class="pc-dmg-btn" data-dmg="lightning">Ltng.</button>
                        <button type="action" name="act_pc_toggle_acid" class="pc-dmg-btn" data-dmg="acid">Acid</button>
                        <button type="action" name="act_pc_toggle_thunder" class="pc-dmg-btn" data-dmg="thunder">Thund.</button>
                        <button type="action" name="act_pc_toggle_force" class="pc-dmg-btn" data-dmg="force">Force</button>
                        <button type="action" name="act_pc_toggle_psychic" class="pc-dmg-btn" data-dmg="psychic">Psych.</button>
                        <button type="action" name="act_pc_toggle_necrotic" class="pc-dmg-btn" data-dmg="necrotic">Necro.</button>
                        <button type="action" name="act_pc_toggle_radiant" class="pc-dmg-btn" data-dmg="radiant">Rad.</button>
                        <button type="action" name="act_pc_toggle_poison" class="pc-dmg-btn" data-dmg="poison">Poison</button>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Wealth</h2>
                </div>
                <div class="wealth-grid">
                    <div class="wealth-item">
                        <label class="field-label">Purse</label>
                        <input type="number" name="attr_wealth_purse" value="0" readonly title="Use buttons below">
                    </div>
                    <div class="wealth-item">
                        <label class="field-label">Bank</label>
                        <input type="number" name="attr_wealth_bank" value="0" readonly title="Use buttons below">
                    </div>
                </div>
                <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px;">
                    <button type="action" name="act_wealth_earn" class="btn-small" style="background: #6b8e6b; color: #fff;">EARN</button>
                    <button type="action" name="act_wealth_spend" class="btn-small" style="background: #a65d57; color: #fff;">SPEND</button>
                    <button type="action" name="act_wealth_deposit" class="btn-small" title="Purse to Bank">DEPOSIT</button>
                    <button type="action" name="act_wealth_withdraw" class="btn-small" title="Bank to Purse">WITHDRAW</button>
                </div>
            </div>
            <!-- EXPLORATION RESOURCES SECTION -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">Exploration Resources</h2>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <label class="field-label">Torchlight</label>
                        <div class="resource-selector">
                            <label><input type="radio" name="attr_torchlight_die" value="d12" checked><span class="progress-d12">Ud12</span></label>
                            <label><input type="radio" name="attr_torchlight_die" value="d10"><span class="progress-d10">Ud10</span></label>
                            <label><input type="radio" name="attr_torchlight_die" value="d8"><span class="progress-d8">Ud8</span></label>
                            <label><input type="radio" name="attr_torchlight_die" value="d6"><span class="progress-d6">Ud6</span></label>
                            <label><input type="radio" name="attr_torchlight_die" value="d4"><span class="progress-d4">Ud4</span></label>
                            <label><input type="radio" name="attr_torchlight_die" value="-"><span class="progress-depleted">-</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="field-label">Rations</label>
                        <div class="resource-selector">
                            <label><input type="radio" name="attr_rations_die" value="d12" checked><span class="progress-d12">Ud12</span></label>
                            <label><input type="radio" name="attr_rations_die" value="d10"><span class="progress-d10">Ud10</span></label>
                            <label><input type="radio" name="attr_rations_die" value="d8"><span class="progress-d8">Ud8</span></label>
                            <label><input type="radio" name="attr_rations_die" value="d6"><span class="progress-d6">Ud6</span></label>
                            <label><input type="radio" name="attr_rations_die" value="d4"><span class="progress-d4">Ud4</span></label>
                            <label><input type="radio" name="attr_rations_die" value="-"><span class="progress-depleted">-</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="field-label">Spell Components</label>
                        <div class="resource-selector">
                            <label><input type="radio" name="attr_spell_components_die" value="d12" checked><span class="progress-d12">Ud12</span></label>
                            <label><input type="radio" name="attr_spell_components_die" value="d10"><span class="progress-d10">Ud10</span></label>
                            <label><input type="radio" name="attr_spell_components_die" value="d8"><span class="progress-d8">Ud8</span></label>
                            <label><input type="radio" name="attr_spell_components_die" value="d6"><span class="progress-d6">Ud6</span></label>
                            <label><input type="radio" name="attr_spell_components_die" value="d4"><span class="progress-d4">Ud4</span></label>
                            <label><input type="radio" name="attr_spell_components_die" value="-"><span class="progress-depleted">-</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="field-label">Ammunition</label>
                        <div class="resource-selector">
                            <label><input type="radio" name="attr_ammunition_die" value="d12" checked><span class="progress-d12">Ud12</span></label>
                            <label><input type="radio" name="attr_ammunition_die" value="d10"><span class="progress-d10">Ud10</span></label>
                            <label><input type="radio" name="attr_ammunition_die" value="d8"><span class="progress-d8">Ud8</span></label>
                            <label><input type="radio" name="attr_ammunition_die" value="d6"><span class="progress-d6">Ud6</span></label>
                            <label><input type="radio" name="attr_ammunition_die" value="d4"><span class="progress-d4">Ud4</span></label>
                            <label><input type="radio" name="attr_ammunition_die" value="-"><span class="progress-depleted">-</span></label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- DOWNTIME FOCUS SECTION -->
            <div class="panel">
                <input type="hidden" name="attr_focus_target" value="10">
                <div class="panel-header">
                    <h2 class="panel-title">Downtime Focus</h2>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 2; display: flex; flex-direction: column;">
                            <label class="field-label">Focus Name</label>
                            <input type="text" name="attr_focus_name">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <label class="field-label">Cost to Progress</label>
                            <input type="text" name="attr_focus_cost">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <label class="field-label">Attribute</label>
                            <select name="attr_focus_attr">
                                <option value="str">STR</option>
                                <option value="dex">DEX</option>
                                <option value="con">CON</option>
                                <option value="int" selected>INT</option>
                                <option value="wis">WIS</option>
                                <option value="cha">CHA</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="field-label">Progress</label>
                        <div class="progress-selector">
                            <label><input type="radio" name="attr_focus_progress_die" value="done"><span class="progress-done">DONE</span></label>
                            <label><input type="radio" name="attr_focus_progress_die" value="d4"><span class="progress-d4">Ud4</span></label>
                            <label><input type="radio" name="attr_focus_progress_die" value="d6"><span class="progress-d6">Ud6</span></label>
                            <label><input type="radio" name="attr_focus_progress_die" value="d8"><span class="progress-d8">Ud8</span></label>
                            <label><input type="radio" name="attr_focus_progress_die" value="d10"><span class="progress-d10">Ud10</span></label>
                            <label><input type="radio" name="attr_focus_progress_die" value="d12"><span class="progress-d12">Ud12</span></label>
                            <label><input type="radio" name="attr_focus_progress_die" value="d20" checked><span class="progress-d20">Ud20</span></label>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: center; margin-top: 10px; gap: 10px;">
                        <button type="roll" name="roll_focus_progress" class="btn-small btn-action" 
                            value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Downtime: @{focus_name}}} {{target=[[@{focus_target}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{custom_row=1}} {{custom_label=Cost Paid}} {{custom_value=@{focus_cost}}} {{note=Success: Degrade Progress Die. Nat 1: Degrade twice. Fail: Roll Complication.}}">
                            Progress Focus
                        </button>
                        <button type="roll" name="roll_complication" class="btn-small" style="background: #a65d57;" value="!focusfail">
                        Complication
                        </button>
                    </div>
                </div>
            </div>
            <div class="panel utility-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Utility Rolls</h2>
                </div>
                <div class="utility-buttons">
                    <button type="roll" name="roll_set_camp" class="btn-small" value="!campwatch">Set Camp</button>
                    <button type="roll" name="roll_pc_loot" class="btn-small" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Loot Roll}} {{roll=[[(?{Boss?|No,1|Yes,10} * ?{Monster HD|1})d6]]}} {{note=Hover over result to see 6s (Treasure) or 1s (Architect's Salvage).}}">Loot Roll</button>
                    <button type="roll" name="roll_treasure" class="btn-small" value="!treasure ?{Table|Standard Treasure,regular|Legendary Treasure,legendary} [[?{How many treasures?|1}d1]]">Treasure Roll</button>
                    <button type="roll" name="roll_job_board" class="btn-small" value="!quest">Check Job Board</button>
                    <button type="roll" name="roll_quest_log" class="btn-small" value="!qt">Open Quest Log</button>
                    <button type="roll" name="roll_oofa" class="btn-small" value="!oofa">OofA</button>
                    <button type="roll" name="roll_usagedie" class="btn-small" value="!usagedie">Usage Die</button>
                </div>
            </div>
        </div>
    </div>
    <div class="panel inventory-panel">
        <div class="panel-header">
            <h2 class="panel-title">Inventory</h2>
            <span class="panel-subtitle">Slots: STR = <span name="attr_str">10</span></span>
        </div>
        <div class="inventory-header">
            <span>#</span>
            <span>Rdy</span>
            <span>Item</span>
            <span>Qty/Slots</span>
            <span>Usage Die</span>
            <span>Roll</span>
        </div>
        <fieldset class="repeating_inventory">
            <div class="slot-number"></div>
            <div class="inventory-checkbox-cell" style="display: flex; justify-content: center; align-items: center;">
                <input type="checkbox" name="attr_item_readied" value="1" title="Readied Item">
            </div>
            <input type="text" name="attr_item_name">
            <input type="text" name="attr_item_qty">
            <select name="attr_item_ud">
                <option value="0">—</option>
                <option value="d4">Ud4</option>
                <option value="d6">Ud6</option>
                <option value="d8">Ud8</option>
                <option value="d10">Ud10</option>
                <option value="d12">Ud12</option>
                <option value="d20">Ud20</option>
            </select>
            <button type="roll" name="roll_item_ud" class="btn-small" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=@{item_name} Usage}} {{roll=[[1@{item_ud}cs0cf0]]}} {{note=On 1-2, the die degrades.}}">Use</button>
        </fieldset>
    </div>
    <div class="panel expertise-panel">
        <div class="panel-header">
            <h2 class="panel-title">Expertise and Talents</h2>
        </div>
        <div class="expertise-header">
            <span>Source</span>
            <span>Modifier</span>
            <span>Description</span>
        </div>
        <fieldset class="repeating_expertise">
            <select name="attr_expertise_source" class="expertise-source">
                <option value="CLASS">CLASS</option>
                <option value="SPECIES">SPECIES</option>
                <option value="BACKGROUND">BACKGROUND</option>
                <option value="LEARNED">LEARNED</option>
                <option value="OTHER">OTHER</option>
            </select>
            <select name="attr_expertise_modifier" class="expertise-modifier">
                <option value="Advantage">Advantage</option>
                <option value="Disadvantage">Disadvantage</option>
                <option value="Talent">Talent</option>
            </select>
            <input type="text" name="attr_expertise_desc" class="expertise-desc">
        </fieldset>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Innate Abilities</h2>
        </div>
        <div class="ability-header">
            <span>Source</span>
            <span>Ability</span>
            <span>Description</span>
            <span>Use</span>
        </div>
        <fieldset class="repeating_abilities">
            <select name="attr_ability_source" class="ability-source">
                <option value="CLASS">CLASS</option>
                <option value="SPECIES">SPECIES</option>
                <option value="ITEM">ITEM</option>
                <option value="OTHER">OTHER</option>
            </select>
            <input type="text" name="attr_ability_name" class="ability-name">
            <textarea name="attr_ability_desc" class="ability-desc"></textarea>
            <button type="roll" name="roll_ability_post" class="btn-small" value="&{template:birdhack} {{character_name=@{character_name}}} {{name=@{ability_name}}} {{description=@{ability_desc}}}">Post</button>
        </fieldset>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Magic</h2>
            <button type="roll" name="roll_misfire" class="btn-small" value="!misfire">Spell Misfire Table</button>
        </div>
        <div class="spell-slots-display" style="border: none; background: transparent; padding: 0; margin-bottom: 10px;">
            <div class="spell-slot-item" style="flex-grow: 1; align-items: flex-start;">
                <label style="color: var(--accent-gold); font-size: 11px; margin-bottom: 4px;">Casting Attribute</label>
                <select name="attr_casting_stat" style="width: 100%;">
                    <option value="@{int}" selected>Intelligence</option>
                    <option value="@{wis}">Wisdom</option>
                    <option value="@{cha}">Charisma</option>
                    <option value="@{str}">Strength</option>
                    <option value="@{dex}">Dexterity</option>
                    <option value="@{con}">Constitution</option>
                </select>
            </div>
        </div>
        <div class="spell-header">
            <span>Mem</span>
            <span>Str</span>
            <span>HD</span>
            <span>Name</span>
            <span>Description</span>
            <span>Retain</span>
            <span>Post</span>
        </div>
        <fieldset class="repeating_spells">
            <div class="spell-checkbox-cell">
                <input type="checkbox" name="attr_spell_memorized" value="1">
            </div>
            <div class="spell-checkbox-cell">
                <input type="checkbox" name="attr_spell_strained" value="1">
            </div>
            <input type="number" name="attr_spell_hd" min="1" max="10">
            <input type="text" name="attr_spell_name">
            <textarea name="attr_spell_desc"></textarea>
            <button type="roll" name="roll_spell_retain" class="btn-small" 
                value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Retain: @{spell_name}}} {{target=[[@{casting_stat}]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1} + @{spell_hd}]]}}">
                Retain
            </button>
            <button type="roll" name="roll_spell_post" class="btn-small" 
                value="&{template:birdhack} {{character_name=@{character_name}}} {{name=@{spell_name}}} {{description=@{spell_desc}}} {{hd=Level @{spell_hd}}}">
                Post
            </button>
        </fieldset>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Retinue & Hirelings</h2>
        </div>
        <div class="hireling-header">
            <span>Qty</span>
            <span>Name</span>
            <span>Description</span>
            <span>Cost (Mo.)</span>
            <span>Post</span>
        </div>
        <fieldset class="repeating_hirelings">
            <input type="number" name="attr_hireling_qty" value="1">
            <input type="text" name="attr_hireling_name">
            <textarea name="attr_hireling_desc"></textarea>
            <input type="text" name="attr_hireling_cost" class="cost-input">
            <button type="roll" name="roll_hireling_post" class="btn-small" 
                value="&{template:birdhack} {{character_name=@{character_name}}} {{name=@{hireling_name}}} {{description=@{hireling_desc}}} {{effect=Cost: @{hireling_cost}}} {{hd=Qty: @{hireling_qty}}}">
                Post
            </button>
        </fieldset>
        <div class="hireling-footer">
            <div class="wages-display">
                <label>Total Wages:</label>
                <input type="number" name="attr_wages_total" value="0" readonly>
            </div>
            <button type="roll" name="roll_issue_pay" class="issue-pay-btn"
                value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Issue Pay}} {{effect=The retinue is paid.}} {{damage=[[@{wages_total}]]}} {{reminder=Total Gold Owed}}">
                ISSUE PAY
            </button>
        </div>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Assets & Property</h2>
        </div>
        <div class="assets-header">
            <span>Asset</span>
            <span>Location</span>
            <span>Upkeep (Mo.)</span>
            <span>Post</span>
        </div>
        <fieldset class="repeating_assets">
            <div class="asset-top-row">
                <input type="text" name="attr_asset_name" placeholder="Chlen Beast, Boat, etc">
                <input type="text" name="attr_asset_location">
                <input type="text" name="attr_asset_upkeep" class="cost-input">
                <button type="roll" name="roll_asset_post" class="btn-small" 
                    value="&{template:birdhack} {{character_name=@{character_name}}} {{name=@{asset_name}}} {{custom_row=1}} {{custom_label=Location}} {{custom_value=@{asset_location}}} {{custom_row_2=1}} {{custom_label_2=Upkeep}} {{custom_value_2=@{asset_upkeep}}} {{description=@{asset_notes}}}">
                    Post
                </button>
            </div>
            <div class="asset-bottom-row">
                <textarea name="attr_asset_notes" placeholder="Cargo capacity, crew requirements, stats..."></textarea>
            </div>
        </fieldset>
        <div class="hireling-footer">
            <div class="wages-display">
                <label>Total Upkeep:</label>
                <input type="number" name="attr_upkeep_total" value="0" readonly>
            </div>
            <button type="roll" name="roll_pay_upkeep" class="issue-pay-btn"
                value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Pay Upkeep}} {{effect=Asset maintenance costs paid.}} {{damage=[[@{upkeep_total}]]}} {{reminder=Total Gold Owed}}">
                PAY UPKEEP
            </button>
        </div>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Social & Affiliations</h2>
        </div>
        <div class="social-header">
            <span>Name</span>
            <span>Status / Bond</span>
            <span>Post</span>
        </div>
        <fieldset class="repeating_social">
            <div class="social-top-row">
                <input type="text" name="attr_social_name">
                <select name="attr_social_status">
                    <option value="Patron">Patron</option>
                    <option value="Protégé">Protégé</option>
                    <option value="Ally">Ally</option>
                    <option value="Member">Member</option>
                    <option value="Contact">Contact</option>
                    <option value="Shámtla">Shámtla (Debt)</option>
                    <option value="Life-Debt">Life-Debt</option>
                    <option value="Favor Owed">Favor Owed</option>
                    <option value="Favor Held">Favor Held</option>
                    <option value="Vendetta">Vendetta</option>
                    <option value="Rival">Rival</option>
                    <option value="Wanted">Wanted</option>
                </select>
                <button type="roll" name="roll_social_post" class="btn-small" 
                    value="&{template:birdhack} {{character_name=@{character_name}}} {{name=@{social_name}}} {{custom_row=1}} {{custom_label=Status}} {{custom_value=@{social_status}}} {{description=@{social_desc}}}">
                    Post
                </button>
            </div>
            <div class="social-bottom-row">
                <textarea name="attr_social_desc" placeholder="Terms, Details, Context..."></textarea>
            </div>
        </fieldset>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Experience Ledger</h2>
            <button type="roll" name="roll_carouse" class="btn-small" 
                value="&{template:birdhack} {{character_name=@{character_name}}} {{name=Carouse!}} {{cost=**Cost:** [[(?{How many Experiences are you spending?|1}*2)d8 * 5]] gold}} {{description=**1 - You trashed the place.** Roll your Cost Dice (2d8 × 5) again and ADD it to what you already paid. If you cannot pay, you gain the Debt bond in your Social & Affiliations tab and are hunted by a faction.
**2 - A follower appears.** Infatuated with your glory, they join the party for free and will serve loyally until treated poorly or killed.
**3 - You stared into the abyss and it blinked.** Set your Doom Die to Ud8, even if you are currently Doomed.
**4 - You feel invincible.** Roll your Class Hit Die (e.g., 1d8 for Warrior). Add the result to your Maximum HP permanently.
**5 - You realized your true potential.** Choose ANY Attribute (STR, DEX, CON, INT, WIS, CHA). Roll a d20; if the result is HIGHER than the current score, it permanently increases by 1.
**6 - You won the pot.** You gain your Level Up for free. Take back the gold you just spent.}} {{roll=[[1d6]]}} {{note=Your roll result determines your carousing outcome!}}">
                Carouse!
            </button>
        </div>
        <div style="margin-bottom: 15px; padding: 10px; background: rgba(201, 166, 107, 0.1); border: 1px solid var(--accent-copper); border-radius: 5px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <label class="field-label" style="margin: 0; white-space: nowrap; font-size: 13px; color: var(--accent-gold);">Gaining a Level</label>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <textarea name="attr_level_up_desc" style="flex: 1; min-height: 80px; height: 80px; resize: vertical;" placeholder="Describe what happens when this character levels up..."></textarea>
                <button type="roll" name="roll_level_up_post" class="btn-small btn-action" 
                    value="&{template:birdhack} {{character_name=@{character_name}}} {{name=LEVEL UP!}} {{description=@{level_up_desc}}} {{reminder=Character Advancement}}">
                    Post
                </button>
            </div>
        </div>
        <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 5px; font-style: italic; text-align: center;">
            Check box to mark Deed as <strong>Spent</strong>. Unchecked Deeds are <strong>Banked</strong>.
        </div>
        <div class="experience-list-header">
            <span>Spent</span>
            <span>Deed</span>
            <span>Description</span>
            <span>Post</span>
        </div>
        <fieldset class="repeating_experience">
            <div class="xp-checkbox-cell">
                <input type="checkbox" name="attr_deed_spent" value="1">
            </div>
            <input type="text" name="attr_deed_name">
            <textarea name="attr_deed_desc"></textarea>
            <button type="roll" name="roll_deed_post" class="btn-small" 
                value="&{template:birdhack} {{character_name=@{character_name}}} {{name=@{deed_name}}} {{description=@{deed_desc}}} {{reminder=Deed Log Entry}}">
                Post
            </button>
        </fieldset>
    </div>
    <div class="panel">
        <div class="panel-header">
            <h2 class="panel-title">Notes</h2>
        </div>
        <textarea name="attr_notes" style="min-height: 150px;"></textarea>
    </div>
</div>
<div class="npc-sheet">
    <!-- Hidden attributes for damage type states (0=normal, 1=resistant, 2=vulnerable, 3=immune) -->
    <input type="hidden" name="attr_npc_dmg_bludgeoning" value="0">
    <input type="hidden" name="attr_npc_dmg_slashing" value="0">
    <input type="hidden" name="attr_npc_dmg_piercing" value="0">
    <input type="hidden" name="attr_npc_dmg_fire" value="0">
    <input type="hidden" name="attr_npc_dmg_cold" value="0">
    <input type="hidden" name="attr_npc_dmg_lightning" value="0">
    <input type="hidden" name="attr_npc_dmg_acid" value="0">
    <input type="hidden" name="attr_npc_dmg_thunder" value="0">
    <input type="hidden" name="attr_npc_dmg_force" value="0">
    <input type="hidden" name="attr_npc_dmg_psychic" value="0">
    <input type="hidden" name="attr_npc_dmg_necrotic" value="0">
    <input type="hidden" name="attr_npc_dmg_radiant" value="0">
    <input type="hidden" name="attr_npc_dmg_poison" value="0">
    
    <input type="hidden" name="attr_npc_target" value="10">
    <input type="radio" name="attr_npc_creature_type" value="npc" class="npc-type-npc" checked style="display:none;">
    <input type="radio" name="attr_npc_creature_type" value="ally" class="npc-type-ally" style="display:none;">
    
    <div class="npc-panel-wrapper">
        <div class="panel npc-main-panel">
            <!-- Type Toggle Header -->
            <div class="panel-header npc-panel-header">
                <h2 class="panel-title npc-panel-title">NPC / Creature</h2>
                <select name="attr_npc_creature_type_select" class="npc-type-selector">
                    <option value="npc" selected>NPC</option>
                    <option value="ally">ALLY</option>
                </select>
            </div>
            
            <!-- Ally Mode Notice -->
            <div class="ally-mode-notice">
                <span>ALLY MODE: This creature rolls like a PC (roll-under Target)</span>
            </div>
            
            <!-- ALLY ROLL MODE (always visible at top) -->
            <div class="ally-roll-mode">
                <label class="npc-field-label" style="margin-bottom: 5px; display: block;">Roll Mode</label>
                <div style="display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: nowrap;">
                    <label class="npc-label" style="cursor: pointer; white-space: nowrap;"><input type="radio" name="attr_npc_roll_mode" value="2d20kl1cf20cs1"> Advantage</label>
                    <label class="npc-label" style="cursor: pointer; white-space: nowrap;"><input type="radio" name="attr_npc_roll_mode" value="1d20cf20cs1" checked> Normal</label>
                    <label class="npc-label" style="cursor: pointer; white-space: nowrap;"><input type="radio" name="attr_npc_roll_mode" value="2d20kh1cf20cs1"> Disadvantage</label>
                    <button type="roll" name="roll_npc_check" class="btn-small" style="background: #6b8e6b; margin-left: 15px; padding: 8px 20px; white-space: nowrap;"
                        value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=Check}} {{target=[[@{npc_target}]]}} {{roll=[[@{npc_roll_mode}]]}}">
                        Roll Check
                    </button>
                </div>
            </div>
            
            <!-- THREE COLUMN LAYOUT -->
            <div class="npc-three-col">
                <!-- COLUMN 1: Identity -->
                <div class="npc-col npc-col-identity">
                    <div class="npc-avatar-frame">
                        <img name="attr_character_avatar" class="npc-avatar-img">
                    </div>
                    <div class="npc-identity-fields">
                        <div class="npc-field">
                            <label class="npc-field-label">Name</label>
                            <input type="text" name="attr_npc_name" class="npc-input">
                        </div>
                        <div class="npc-field">
                            <label class="npc-field-label">Faction</label>
                            <input type="text" name="attr_npc_species" class="npc-input">
                        </div>
                        <div class="npc-field-row">
                            <div class="npc-field half">
                                <label class="npc-field-label">Size</label>
                                <select name="attr_npc_size" class="npc-input">
                                    <option value="Tiny">Tiny</option>
                                    <option value="Small">Small</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="Large">Large</option>
                                    <option value="Huge">Huge</option>
                                    <option value="Gargantuan">Gargantuan</option>
                                </select>
                            </div>
                            <div class="npc-field half">
                                <label class="npc-field-label">Type</label>
                                <input type="text" name="attr_npc_type" class="npc-input">
                            </div>
                        </div>
                        <div class="npc-field-row">
                            <div class="npc-field half">
                                <label class="npc-field-label">Biome</label>
                                <select name="attr_npc_biome" class="npc-input">
                                    <option value="ALL">ALL</option>
                                    <option value="GRASSLAND">GRASSLAND</option>
                                    <option value="WOODLAND">WOODLAND</option>
                                    <option value="WETLAND">WETLAND</option>
                                    <option value="HIGHLAND">HIGHLAND</option>
                                    <option value="BADLAND">BADLAND</option>
                                    <option value="UNDERWORLD">UNDERWORLD</option>
                                </select>
                            </div>
                            <div class="npc-field half">
                                <label class="npc-field-label">Encounter Size</label>
                                <input type="text" name="attr_npc_faction" class="npc-input">
                            </div>
                        </div>
                        <div class="npc-field-row" style="margin-top: 8px;">
                            <div class="npc-field half">
                                <label class="npc-field-label">Movement</label>
                                <input type="text" name="attr_npc_movement" class="npc-input">
                            </div>
                            <div class="npc-field half">
                                <label class="npc-field-label">Morale</label>
                                <button type="roll" name="roll_npc_morale" class="btn-small npc-morale-btn"
                                    value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=Morale Check}} {{target=[[@{npc_hd}]]}} {{roll=[[1d12cs0cf0]]}} {{note=Roll ≤ HD to hold. Fail = flee/surrender.}}">
                                    Roll
                                </button>
                            </div>
                        </div>
                        <div class="npc-field" style="margin-top: 8px;">
                            <label class="npc-field-label">Loot</label>
                            <button type="action" name="act_npc_loot" class="btn-small npc-loot-btn">
                                Roll Loot
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- COLUMN 2: Combat -->
                <div class="npc-col npc-col-combat">
                    <div class="npc-combat-stats">
                        <div class="npc-stat-box">
                            <label class="npc-stat-label">HD</label>
                            <input type="number" name="attr_npc_hd" value="1" min="0" class="npc-stat-input">
                        </div>
                        <div class="npc-stat-box">
                            <label class="npc-stat-label">Target</label>
                            <input type="number" name="attr_npc_target_display" value="10" readonly class="npc-stat-input npc-target-display">
                        </div>
                        <div class="npc-stat-box">
                            <label class="npc-stat-label">HP</label>
                            <input type="number" name="attr_npc_hp" value="0" class="npc-stat-input">
                        </div>
                        <div class="npc-stat-box">
                            <label class="npc-stat-label">AV</label>
                            <input type="number" name="attr_npc_av" value="0" class="npc-stat-input">
                        </div>
                        <div class="npc-stat-box">
                            <label class="npc-stat-label">DR</label>
                            <input type="number" name="attr_npc_dr" value="0" class="npc-stat-input">
                        </div>
                    </div>
                    
                    <!-- Damage Type Grids -->
                    <div class="npc-dmg-section">
                        <label class="npc-field-label" style="margin-bottom: 4px;">Damage Types <span style="font-weight: normal; font-size: 9px;">(click to cycle)</span></label>
                        
                        <!-- Mundane Grid (3 wide) -->
                        <div class="npc-dmg-grid mundane-grid">
                            <div class="dmg-cell" data-dmg="bludgeoning">
                                <button type="action" name="act_toggle_bludgeoning" class="dmg-btn">Bludg.</button>
                            </div>
                            <div class="dmg-cell" data-dmg="slashing">
                                <button type="action" name="act_toggle_slashing" class="dmg-btn">Slash.</button>
                            </div>
                            <div class="dmg-cell" data-dmg="piercing">
                                <button type="action" name="act_toggle_piercing" class="dmg-btn">Pierce.</button>
                            </div>
                        </div>
                        
                        <hr class="npc-dmg-divider">
                        
                        <!-- Elemental Grid (5 wide, 2 rows) -->
                        <div class="npc-dmg-grid elemental-grid">
                            <div class="dmg-cell" data-dmg="fire">
                                <button type="action" name="act_toggle_fire" class="dmg-btn">Fire</button>
                            </div>
                            <div class="dmg-cell" data-dmg="cold">
                                <button type="action" name="act_toggle_cold" class="dmg-btn">Cold</button>
                            </div>
                            <div class="dmg-cell" data-dmg="lightning">
                                <button type="action" name="act_toggle_lightning" class="dmg-btn">Ltng.</button>
                            </div>
                            <div class="dmg-cell" data-dmg="acid">
                                <button type="action" name="act_toggle_acid" class="dmg-btn">Acid</button>
                            </div>
                            <div class="dmg-cell" data-dmg="thunder">
                                <button type="action" name="act_toggle_thunder" class="dmg-btn">Thund.</button>
                            </div>
                            <div class="dmg-cell" data-dmg="force">
                                <button type="action" name="act_toggle_force" class="dmg-btn">Force</button>
                            </div>
                            <div class="dmg-cell" data-dmg="psychic">
                                <button type="action" name="act_toggle_psychic" class="dmg-btn">Psych.</button>
                            </div>
                            <div class="dmg-cell" data-dmg="necrotic">
                                <button type="action" name="act_toggle_necrotic" class="dmg-btn">Necro.</button>
                            </div>
                            <div class="dmg-cell" data-dmg="radiant">
                                <button type="action" name="act_toggle_radiant" class="dmg-btn">Rad.</button>
                            </div>
                            <div class="dmg-cell" data-dmg="poison">
                                <button type="action" name="act_toggle_poison" class="dmg-btn">Poison</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ATTACKS (5 fixed rows) -->
                    <div class="npc-attacks-section">
                        <label class="npc-field-label">Attacks</label>
                        <div class="npc-attacks-header">
                            <span>Name</span>
                            <span>Dmg</span>
                            <span>Target</span>
                            <span>Range</span>
                            <span></span>
                        </div>
                        
                        <!-- Attack 1 -->
                        <div class="npc-attack-block">
                            <div class="npc-attack-row">
                                <input type="text" name="attr_npc_atk1_name">
                                <input type="text" name="attr_npc_atk1_dmg">
                                <select name="attr_npc_atk1_target">
                                    <option value="Single">Single</option>
                                    <option value="Multi">Multi</option>
                                    <option value="Cone">Cone</option>
                                    <option value="Line">Line</option>
                                    <option value="Area">Area</option>
                                    <option value="Burst">Burst</option>
                                    <option value="All">All</option>
                                </select>
                                <select name="attr_npc_atk1_range">
                                    <option value="Close">Close</option>
                                    <option value="Nearby">Nearby</option>
                                    <option value="Far">Far</option>
                                </select>
                                <button type="roll" name="roll_npc_atk1" class="btn-small npc-post-btn"
                                    value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=@{npc_atk1_name}}} {{damage=[[@{npc_atk1_dmg}cs0cf0]]}} {{note=@{npc_atk1_target} ・ @{npc_atk1_range}}} {{effect=@{npc_atk1_effect}}}">
                                    Post
                                </button>
                            </div>
                            <input type="text" name="attr_npc_atk1_effect" class="npc-attack-effect">
                            <hr class="npc-attack-divider">
                        </div>
                        
                        <!-- Attack 2 -->
                        <div class="npc-attack-block">
                            <div class="npc-attack-row">
                                <input type="text" name="attr_npc_atk2_name">
                                <input type="text" name="attr_npc_atk2_dmg">
                                <select name="attr_npc_atk2_target">
                                    <option value="Single">Single</option>
                                    <option value="Multi">Multi</option>
                                    <option value="Cone">Cone</option>
                                    <option value="Line">Line</option>
                                    <option value="Area">Area</option>
                                    <option value="Burst">Burst</option>
                                    <option value="All">All</option>
                                </select>
                                <select name="attr_npc_atk2_range">
                                    <option value="Close">Close</option>
                                    <option value="Nearby">Nearby</option>
                                    <option value="Far">Far</option>
                                </select>
                                <button type="roll" name="roll_npc_atk2" class="btn-small npc-post-btn"
                                    value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=@{npc_atk2_name}}} {{damage=[[@{npc_atk2_dmg}cs0cf0]]}} {{note=@{npc_atk2_target} ・ @{npc_atk2_range}}} {{effect=@{npc_atk2_effect}}}">
                                    Post
                                </button>
                            </div>
                            <input type="text" name="attr_npc_atk2_effect" class="npc-attack-effect">
                            <hr class="npc-attack-divider">
                        </div>
                        
                        <!-- Attack 3 -->
                        <div class="npc-attack-block">
                            <div class="npc-attack-row">
                                <input type="text" name="attr_npc_atk3_name">
                                <input type="text" name="attr_npc_atk3_dmg">
                                <select name="attr_npc_atk3_target">
                                    <option value="Single">Single</option>
                                    <option value="Multi">Multi</option>
                                    <option value="Cone">Cone</option>
                                    <option value="Line">Line</option>
                                    <option value="Area">Area</option>
                                    <option value="Burst">Burst</option>
                                    <option value="All">All</option>
                                </select>
                                <select name="attr_npc_atk3_range">
                                    <option value="Close">Close</option>
                                    <option value="Nearby">Nearby</option>
                                    <option value="Far">Far</option>
                                </select>
                                <button type="roll" name="roll_npc_atk3" class="btn-small npc-post-btn"
                                    value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=@{npc_atk3_name}}} {{damage=[[@{npc_atk3_dmg}cs0cf0]]}} {{note=@{npc_atk3_target} ・ @{npc_atk3_range}}} {{effect=@{npc_atk3_effect}}}">
                                    Post
                                </button>
                            </div>
                            <input type="text" name="attr_npc_atk3_effect" class="npc-attack-effect">
                            <hr class="npc-attack-divider">
                        </div>
                        
                        <!-- Attack 4 -->
                        <div class="npc-attack-block">
                            <div class="npc-attack-row">
                                <input type="text" name="attr_npc_atk4_name">
                                <input type="text" name="attr_npc_atk4_dmg">
                                <select name="attr_npc_atk4_target">
                                    <option value="Single">Single</option>
                                    <option value="Multi">Multi</option>
                                    <option value="Cone">Cone</option>
                                    <option value="Line">Line</option>
                                    <option value="Area">Area</option>
                                    <option value="Burst">Burst</option>
                                    <option value="All">All</option>
                                </select>
                                <select name="attr_npc_atk4_range">
                                    <option value="Close">Close</option>
                                    <option value="Nearby">Nearby</option>
                                    <option value="Far">Far</option>
                                </select>
                                <button type="roll" name="roll_npc_atk4" class="btn-small npc-post-btn"
                                    value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=@{npc_atk4_name}}} {{damage=[[@{npc_atk4_dmg}cs0cf0]]}} {{note=@{npc_atk4_target} ・ @{npc_atk4_range}}} {{effect=@{npc_atk4_effect}}}">
                                    Post
                                </button>
                            </div>
                            <input type="text" name="attr_npc_atk4_effect" class="npc-attack-effect">
                            <hr class="npc-attack-divider">
                        </div>
                        
                        <!-- Attack 5 -->
                        <div class="npc-attack-block">
                            <div class="npc-attack-row">
                                <input type="text" name="attr_npc_atk5_name">
                                <input type="text" name="attr_npc_atk5_dmg">
                                <select name="attr_npc_atk5_target">
                                    <option value="Single">Single</option>
                                    <option value="Multi">Multi</option>
                                    <option value="Cone">Cone</option>
                                    <option value="Line">Line</option>
                                    <option value="Area">Area</option>
                                    <option value="Burst">Burst</option>
                                    <option value="All">All</option>
                                </select>
                                <select name="attr_npc_atk5_range">
                                    <option value="Close">Close</option>
                                    <option value="Nearby">Nearby</option>
                                    <option value="Far">Far</option>
                                </select>
                                <button type="roll" name="roll_npc_atk5" class="btn-small npc-post-btn"
                                    value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=@{npc_atk5_name}}} {{damage=[[@{npc_atk5_dmg}cs0cf0]]}} {{note=@{npc_atk5_target} ・ @{npc_atk5_range}}} {{effect=@{npc_atk5_effect}}}">
                                    Post
                                </button>
                            </div>
                            <input type="text" name="attr_npc_atk5_effect" class="npc-attack-effect">
                        </div>
                    </div>
                </div>
                
                <!-- COLUMN 3: Description -->
                <div class="npc-col npc-col-desc">
                    <label class="npc-field-label">Description & Notes</label>
                    <textarea name="attr_npc_description" class="npc-desc-textarea"></textarea>
                </div>
            </div>
            
            <!-- ALLY ROLL MODE (only shows for allies) -->
            
            <!-- ABILITIES SECTION -->
            <div class="npc-abilities-section">
                <h3 class="npc-section-title">Innate Abilities</h3>
                <div class="npc-abilities-header">
                    <span>Name</span>
                    <span>Description</span>
                    <span>Post</span>
                </div>
                <fieldset class="repeating_npcabilities">
                    <div class="npc-ability-row">
                        <input type="text" name="attr_npc_ability_name">
                        <textarea name="attr_npc_ability_desc"></textarea>
                        <button type="roll" name="roll_npc_ability" class="btn-small"
                            value="&{template:birdhack} {{character_name=@{npc_name}}} {{name=@{npc_name}: @{npc_ability_name}}} {{description=@{npc_ability_desc}}}">
                            Post
                        </button>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
</div>
<rolltemplate class="sheet-rolltemplate-birdhack">
    {{#character_name}}
    <div class="sheet-charname">{{character_name}}</div>
    {{/character_name}}
    <div class="sheet-header">
        <h3>{{name}}</h3>
    </div>
    {{#cost}}
    <div class="sheet-row">
        <span class="sheet-value" style="font-size: 13px; color: #d4af37;">{{cost}}</span>
    </div>
    {{/cost}}
    {{#target}}
    <div class="sheet-row">
        <span class="sheet-label">Target</span>
        <span class="sheet-value">{{target}}</span>
    </div>
    {{/target}}
    {{#roll}}
    <div class="sheet-row">
        <span class="sheet-label">Roll</span>
        <span class="sheet-value">{{roll}}</span>
    </div>
    {{/roll}}
    {{#damage}}
    <div class="sheet-row">
        <span class="sheet-label">Damage</span>
        <span class="sheet-value">{{damage}}</span>
    </div>
    {{/damage}}
    {{#custom_row}}
    <div class="sheet-row">
        <span class="sheet-label">{{custom_label}}</span>
        <span class="sheet-value">{{custom_value}}</span>
    </div>
    {{/custom_row}}
    {{#custom_row_2}}
    <div class="sheet-row">
        <span class="sheet-label">{{custom_label_2}}</span>
        <span class="sheet-value">{{custom_value_2}}</span>
    </div>
    {{/custom_row_2}}
    {{#effect}}
    <div class="sheet-row">
        <span class="sheet-label">Effect</span>
        <span class="sheet-value">{{effect}}</span>
    </div>
    {{/effect}}
    {{#description}}
    <div class="sheet-desc">{{description}}</div>
    {{/description}}
    {{#treasurelist}}
    <div class="sheet-treasurelist">{{treasurelist}}</div>
    {{/treasurelist}}
    {{#hd}}
    <div class="sheet-row">
        <span class="sheet-label">HD</span>
        <span class="sheet-value">{{hd}}</span>
    </div>
    {{/hd}}
    {{#treasures}}
    <div class="sheet-row">
        <span class="sheet-label">Treasures</span>
        <span class="sheet-value" style="color: #d4af37;">{{treasures}}</span>
    </div>
    {{/treasures}}
    {{#note}}
    <div class="sheet-row">
        <span class="sheet-value" style="font-size: 11px; color: #a89984;">{{note}}</span>
    </div>
    {{/note}}
    {{#notes}}
    <div class="sheet-row sheet-notes">
        <span class="sheet-label">Notes</span>
        <span class="sheet-value">{{notes}}</span>
    </div>
    {{/notes}}
    {{#reminder}}
    <div class="sheet-reminder">{{reminder}}</div>
    {{/reminder}}
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-birdspell">
    {{#character_name}}
    <div class="sheet-charname">{{character_name}}</div>
    {{/character_name}}
    <div class="sheet-header">
        <h3>{{name}}</h3>
    </div>
    {{#school}}
    <div class="sheet-row">
        <span class="sheet-label">School</span>
        <span class="sheet-value">{{school}}</span>
    </div>
    {{/school}}
    {{#temple}}
    <div class="sheet-row">
        <span class="sheet-label">Temple</span>
        <span class="sheet-value">{{temple}}</span>
    </div>
    {{/temple}}
    {{#cost}}
    <div class="sheet-row">
        <span class="sheet-label">Cost</span>
        <span class="sheet-value">{{cost}}</span>
    </div>
    {{/cost}}
    {{#target}}
    <div class="sheet-row">
        <span class="sheet-label">Target</span>
        <span class="sheet-value">Under {{target}}</span>
    </div>
    {{/target}}
    <div class="sheet-row">
        <span class="sheet-label">Roll</span>
        <span class="sheet-value">{{roll}}</span>
    </div>
    {{#note}}
    <div class="sheet-row">
        <span class="sheet-value" style="font-size: 11px; color: #a89984;">{{note}}</span>
    </div>
    {{/note}}
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-birdtable">
    {{#character_name}}
    <div class="sheet-charname">{{character_name}}</div>
    {{/character_name}}
    <div class="sheet-header">
        <h3>{{name}}</h3>
    </div>
    <div class="sheet-row">
        <span class="sheet-label">Roll</span>
        <span class="sheet-value">{{roll}}</span>
    </div>
    <div class="sheet-result-text">
        {{#rollTotal() roll 1}}
        <strong>1 - KO'd</strong><br>
        Knocked out for 1d4 rounds.
        {{/rollTotal() roll 1}}
        {{#rollTotal() roll 2}}
        <strong>2 - Fat Head</strong><br>
        Disadvantage on INT tests until Long Rest.
        {{/rollTotal() roll 2}}
        {{#rollTotal() roll 3}}
        <strong>3 - Cracked Bones</strong><br>
        Disadvantage on STR/DEX tests until Long Rest.
        {{/rollTotal() roll 3}}
        {{#rollTotal() roll 4}}
        <strong>4 - Crippled</strong><br>
        Lose use of a limb. Movement halved.
        {{/rollTotal() roll 4}}
        {{#rollTotal() roll 5}}
        <strong>5 - Disfigured</strong><br>
        Disadvantage on CHA tests. Permanent scar.
        {{/rollTotal() roll 5}}
        {{#rollTotal() roll 6}}
        <strong>6 - DEAD</strong><br>
        Your story ends here.
        {{/rollTotal() roll 6}}
    </div>
</rolltemplate>
<script type="text/worker">
// ==========================================
// CLASS-BASED STAT CALCULATIONS
// ==========================================

const CLASS_DATA = {
    "Warrior":     { hd: "d8",  damage: "d6",  prog: "per HD" },
    "Scout":      { hd: "d8",  damage: "d8",  prog: "per Even" },
    "Berzerker":   { hd: "d10", damage: "d10", prog: "per Even" },
    "Sentinel":    { hd: "d8",  damage: "d4",  prog: "per Even" },
    "Assassin":        { hd: "d6",  damage: "d8",  prog: "per Even" },
    "Grappler":    { hd: "d10", damage: "d6",  prog: "+HD" },
    "Beastmaster": { hd: "d8",  damage: "d6",  prog: "+HD" },
    "Shapeshifter":{ hd: "d4",  damage: "d4",  prog: "+HD" },
    "Physician":    { hd: "d8",  damage: "d8",  prog: "per Even" },
    "Magician":       { hd: "d4",  damage: "d4",  prog: "None" },
    "Mystic":      { hd: "d6",  damage: "d4",  prog: "None" },
    "Dilettante":  { hd: "d6",  damage: "d4",  prog: "None" },
    "Diabolist":    { hd: "d6",  damage: "d4",  prog: "None" },
    "Hierophant":      { hd: "d6",  damage: "d4",  prog: "None" },
    "Chanter":     { hd: "d8",  damage: "d4",  prog: "None" },
    "Maledictor":  { hd: "d10",  damage: "d10",  prog: "per Even" },
    "Tactician":{ hd: "d8",  damage: "d8",  prog: "per Even" },
    "Architect":   { hd: "d8",  damage: "d6",  prog: "per Even" }
};

// Class Expertise - auto-populated when class is selected
const CLASS_EXPERTISE = {
    "Warrior": [
        "Breaking down doors and barricades.",
        "Resisting shoves and grabs.",
        "Training or performing athletic feats.",
    ],
    "Scout": [
        "Arming and disarming non-magical traps.",
        "Moving silently and stalking.",
        "Tracking creatures and searching for things.",
    ],
    "Berzerker": [
        "Threatening and intimidating non-combatants.",
        "Impressive feats of athleticism.",
        "Resisting and recovering from negative STATUS effects.",
    ],
    "Sentinel": [
        "Fixing your own Damaged Armor Dice.",
        "Resisting grabs, trips, shoves, and other knock-back effects.",
        "Resisting the effects of heat and exhaustion.",
    ],
    "Assassin": [
        "Moving silently, stalking, and escaping.",
        "Concealing things, planting things, cracking mundane locks, and pilfering from pockets, belts, and bags.",
        "Intimidating witnesses or victims.",
    ],
    "Grappler": [
        "Theatrical performances and feats of strength.",
        "Resisting negative STATUS effects.",
        "Resisting being moved or knocked over.",
    ],
    "Beastmaster": [
        "Tracking and training beasts.",
        "Resisting poisons and toxins.",
        "Foraging.",
    ],
    "Shapeshifter": [
        "Studying and impersonating individuals.",
        "Judging intentions and body language.",
    ],
    "Maledictor": [
        "Scrutinizing testimony, omens, and demeanors.",
        "Using legalese to persuade or confuse.",
        "Attacking and defending against Demons.",
    ],
    "Tactician": [
        "Retinue when making MORALE Tests.",
        "On Camp Watch.",
        "Overlooking battlefields and perceiving threats.",
    ],
    "Physician": [
        "Resisting diseases, poisons, toxins, and drain effects.",
        "Identifying the weaknesses and resistances of creatures, and recalling biological lore.",
        "Determining causes of death.",
    ],
    "Architect": [
        "Assessing and interacting with structural integrity, weak points, and load-bearing elements.",
        "Operating or sabotaging mechanical devices, locks, and traps.",
        "Repairing your own Damaged Armor Die.",
    ],
    "Magician": [
        "Recalling esoteric, arcane, or occult lore.",
        "Deciphering magical runes, sigils, and encryptions.",
        "Discerning the purpose of arcane ritual sites, ley-lines, sacrificial sites, or related esoteric locations.",
    ],
    "Mystic": [
        "Delving into records and archives in search of information on relics, magical artifacts, scrolls, and tomes.",
        "Identifying scrolls.",
        "Appraising ancient devices and magical mechanisms.",
    ],
    "Dilettante": [
        "Reading intentions and detecting falsities.",
        "Finding buyers, sellers, hirelings, and specialists.",
        "Engaging in political intrigues, making social connections, and gossiping.",
    ],
    "Diabolist": [
        "Recalling lore about demons and aberrant entities and their rituals.",
        "Bargaining and negotiating contracts with extraplanar entities.",
        "Resisting NECROTIC damage and effects.",
    ],
    "Hierophant": [
        "Deciphering written or verbal ancient languages and when learning foreign languages.",
        "Performing sermons.",
        "Recalling academic lore in the fields of administration, alchemy, ancient devices, architecture, botany, demonology, geology, history, literature, medicine, and zoology.",
    ],
    "Chanter": [
        "Performing voice and sound mimicry.",
        "Performing music, oration, or stagecraft to captivate, distract, or entertain.",
        "Resisting fear, charm, and mind-controlling effects.",
    ],
};

// Class Actions - Noble (Stability), Noble (Change), Ignoble
const CLASS_ACTIONS = {
    "Warrior":     { "stability": "Honorable and Disciplined", "change": "Fierce and Glory-seeking", "ignoble": "Aimless and Arbitrary" },
    "Scout":       { "stability": "Reverent and Wise", "change": "Wild and Bold", "ignoble": "Wasteful and Timid" },
    "Berzerker":   { "stability": "Grim and Ritualistic", "change": "Savage and Ecstatic", "ignoble": "Irreverent and Passionless" },
    "Sentinel":    { "stability": "Steadfast and Vigilant", "change": "Wrathful and Innovative", "ignoble": "Negligent and Complacent" },
    "Assassin":    { "stability": "Professional and Reliable", "change": "Ruthless and Opportunistic", "ignoble": "Sloppy and Squeamish" },
    "Grappler":    { "stability": "Disciplined and Enthusiastic", "change": "Boastful and Quarrelsome", "ignoble": "Lazy and Meek" },
    "Beastmaster": { "stability": "Patient and Nurturing", "change": "Territorial and Predatory", "ignoble": "Neglectful and Submissive" },
    "Shapeshifter":{ "stability": "Immersed and Primal", "change": "Libidinal and Deceitful", "ignoble": "Repressed and Vulnerable" },
    "Physician":   { "stability": "Clinical and Thoughtful", "change": "Vampiric and Experimental", "ignoble": "Careless and Stagnant" },
    "Magician":    { "stability": "Scholarly and Inquisitive", "change": "Ambitious and Transgressive", "ignoble": "Incurious and Complacent" },
    "Mystic":      { "stability": "Fascinated and Categorical", "change": "Acquisitive and Secretive", "ignoble": "Indifferent and Indiscreet" },
    "Dilettante":  { "stability": "Diplomatic and Keen", "change": "Manipulative and Scheming", "ignoble": "Tactless and Oblivious" },
    "Diabolist":   { "stability": "Contractual and Methodical", "change": "Domineering and Ambitious", "ignoble": "Oathbreaking and Subservient" },
    "Hierophant":  { "stability": "Pious and Charitable", "change": "Zealous and Evangelical", "ignoble": "Faithless and Selfish" },
    "Chanter":     { "stability": "Inspiring and Jovial", "change": "Provocative and Iconoclastic", "ignoble": "Dreary and Conformist" },
    "Maledictor":  { "stability": "Just and Impartial", "change": "Vindictive and Absolute", "ignoble": "Biased and Permissive" },
    "Tactician":   { "stability": "Strategic and Protective", "change": "Bold and Conquering", "ignoble": "Reckless and Aggressive" },
    "Architect":   { "stability": "Meticulous and Civic-minded", "change": "Visionary and Tactical", "ignoble": "Fumbling and Uninspired" }
};

// Reputation Effects
const REPUTATION_EFFECTS = {
    "impeccable": "You are revered. People defer to you, seek your favor, and trust you implicitly.",
    "noble": "You are respected. Strangers give you the benefit of the doubt and welcome your presence.",
    "proper": "You are unremarkable. People treat you fairly but without special regard.",
    "ignoble": "You are distrusted. People question your motives, watch their valuables, and tolerate rather than welcome you.",
    "shameless": "You are shunned. Doors close, deals sour, and no one will defend or vouch for you."
};

// Reputation dice for climbing up (hard)
const REPUTATION_DICE_UP = {
    "impeccable": "1d8",
    "noble": "1d8",
    "proper": "1d8",
    "ignoble": "1d8",
    "shameless": "1d10"
};

// Update reputation effect and dice when reputation changes
on("change:reputation sheet:opened", function() {
    getAttrs(["reputation"], function(values) {
        const rep = values.reputation || "proper";
        const effect = REPUTATION_EFFECTS[rep] || REPUTATION_EFFECTS["proper"];
        const dieUp = REPUTATION_DICE_UP[rep] || "1d8";
        setAttrs({ 
            reputation_effect: effect,
            reputation_die_up: dieUp
        });
    });
});

// Class leveling rules - auto-populated in Experience Ledger
const CLASS_LEVELING = {
    "Warrior": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for one Attribute of your choice.\n• Gain 1 HD - Roll 1d8 and add the result to your Maximum HP.\n• At each level, gain +1 Damage Die.",
    "Scout": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for one Attribute of your choice.\n• Gain 1 HD - Roll 1d8 and add the result to your Maximum HP.\n• At Even levels, gain +1 Damage Die.",
    "Berzerker": "When you gain a Level:\n• First, re-roll your Hit Die total. If the number is higher than your current Maximum HP, replace it with the newly rolled number.\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for one Attribute of your choice.\n• Gain 1 HD - Roll 1d10 and add the result to your Maximum HP.\n• At Even levels, gain +1 Damage Die.",
    "Sentinel": "When you gain a Level:\n• For no cost, restore all of your Damaged and Destroyed Armor Dice.\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for one Attribute of your choice.\n• Gain 1 HD - Roll 1d8 and add the result to your Maximum HP.\n• At each level, gain +1 Damage Die.",
    "Assassin": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for your DEX Attribute.\n• Gain 1 HD - Roll 1d6 and add the result to your Maximum HP.\n• At each level, gain +1 Damage Die.",
    "Grappler": "When you gain a Level:\n• First, re-roll your Hit Die total. If the number is higher than your current Maximum HP, replace it with the newly rolled number.\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for your STR Attribute.\n• Gain 1 HD - Roll 1d10 and add the result to your Maximum HP.\n• At each level, gain +1 Damage Die.",
    "Beastmaster": "To advance to a new Level, you must know a total number of Tricks equal to half the Level you are attaining (rounded down).\nWhen you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for WIS or STR.\n• Gain 1 HD - Roll 1d8 and add the result to your Maximum HP.\n• At each level, gain +1 Damage Point.",
    "Shapeshifter": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for CHA.\n• Gain 1 HD - Roll 1d4 and add the result to your Maximum HP.\n• At each level, gain +1 Damage Point.",
    "Physician": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for DEX or INT.\n• Gain 1 HD - Roll 1d8 and add the result to your Maximum HP.\n• At odd levels, add +1 Spell Memorization Slot.\n• At even levels, gain +1 Damage Die.",
    "Magician": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for INT.\n• Gain 1 HD - Roll 1d4 and add the result to your Maximum HP.\n• At each level, add +1 Spell Memorization Slot.",
    "Mystic": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for WIS.\n• Gain 1 HD - Roll 1d6 and add the result to your Maximum HP.\n• At each level, add +1 Spell Memorization Slot.",
    "Dilettante": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for CHA or WIS.\n• Gain 1 HD - Roll 1d4 and add the result to your Maximum HP.\n• At each level, add +1 Spell Memorization Slot.",
    "Diabolist": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for INT.\n• Gain 1 HD - Roll 1d6 and add the result to your Maximum HP.\n• At each level, add +1 Spell Memorization Slot.",
    "Hierophant": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for WIS.\n• Gain 1 HD - Roll 1d6 and add the result to your Maximum HP.\n• At each level, add +1 Spell Memorization Slot.",
    "Chanter": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for CHA or WIS.\n• Gain 1 HD - Roll 1d8 and add the result to your Maximum HP.\n• At each odd level, add +1 Spell Memorization Slot.",
    "Maledictor": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for one Attribute of your choice.\n• Gain 1 HD - Roll 1d10 and add the result to your Maximum HP.\n• At odd levels, add +1 Spell Memorization Slot.\n• At even levels, gain +1 Damage Die.",
    "Tactician": "To advance to a new Level, you must know a total number of Stratagems equal to half the Level you are attaining (rounded down).\nWhen you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for CHA, STR, or INT.\n• Gain 1 HD - Roll 1d8 and add the result to your Maximum HP.\n• At odd levels, add +1 Spell Memorization Slot.\n• At even levels, gain +1 Damage Die.",
    "Architect": "When you gain a Level:\n• Roll a d20 once for each Attribute - if you roll over, it goes up by one point. Make an extra roll for STR or WIS.\n• Gain 1 HD - Roll 1d6 and add the result to your Maximum HP.\n• At each level, add +1 Spell Memorization Slot.\n• At even levels, gain +1 Damage Die."
};

// Class Innate Abilities - auto-populated when class is selected
// Each ability has a name and description
const CLASS_INNATE_ABILITIES = {
    "Warrior": [
        { name: "Relentless", desc: "Once per Round, when a Warrior makes a successful Melee Attack against a creature you can attempt a Combat Maneuver against them before or after applying Damage.", size: "normal" },
        { name: "Extra Layers", desc: "Once per Day, a Warrior can use an Action to attempt a Field Repair of your Damaged Armor Dice. You can add your shield and helm to the Armor Die Pool.", size: "normal" },
        { name: "Issue Manifesto", desc: "When outside of combat, the Warrior can spend an Action to issue a formal challenge to a Nearby intelligent human or non-human species. The GM decides if the challenged enemy Accepts, Declines, or Delegates:\n\nIf they Accept: The Warrior and the challenged enemy enter into a Duel until one side surrenders or reaches 0 HP. If any other creature interferes, the interfering creature and their allies immediately become WEAKENED.\n\nIf they Decline: The challenged enemy is cowed by the Warrior's confidence. They immediately become WEAKENED and their allies Test Morale.\n\nIf they Delegate: The challenged enemy chooses a proxy to fight instead. The proxy must be the same or higher HD than the Warrior. If the proxy is reduced to 0 HP, the original target becomes WEAKENED.", size: "large" },
        { name: "Disciplined Focus", desc: "As a Reaction to acquiring a NEGATIVE Status Effect, the Warrior can spend Inspiration or degrade their Doom Die to remove that Status Effect before its consequences are applied. This cannot be used for the Unconscious Status Effect.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Scout": [
        { name: "Favored Enemy", desc: "When a Scout personally kills at least three of a natural beast, aberration, or non-human species at or below their own HD in a single combat, they can add that beast, aberration, or non-human species to their Favored Enemies list.\n\nAfter a Long Rest, a Scout can declare their Favored Enemy. The Scout has Advantage on all Weapon Attacks Tests and Defense Tests against its Favored Enemy.", size: "normal" },
        { name: "Always Prepared", desc: "The Scout can swap their weapons at any time as a Free Action.\n\nOnce per day, a Scout can spend one Minute digging through their pack. They can choose to do one of the following:\n• Produce one common mundane item that they must use immediately.\n• Re-roll a failed Ud4 Usage Die Test.", size: "normal" },
        { name: "Snipe", desc: "The Scout can spend both their Action and Movement to begin focusing on a specific target with a RANGED Weapon. The Scout automatically fails Initiative Tests while focusing in this way.\n\nIn the following Round, the Scout must make a RANGED Weapon Attack against the target. If the Attack hits, it deals double the total damage to the target. If the Scout is damaged during their focus, they Test Constitution. On a failure, they lose their focus. If the target is behind cover at the time of the Attack, it automatically misses.", size: "large" },
        { name: "Forward Operating Base", desc: "The Scout can spend one Hour and 25 x Party HD to create a Safe location within a dungeon or otherwise dangerous place. The location is completely camouflaged and the party can take a Long Rest as though they were Lodging, rather than Camping.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Berzerker": [
        { name: "Indominable", desc: "As long as the Berzerker is not wearing Armor, they gain Resistance to all non-magical damage and gain Damage Reduction equal to their HD.", size: "normal" },
        { name: "Furious Rage", desc: "Before making a Weapon Attack, the Berzerker can wager up to one point below their Current HP and add it to the Damage of the Weapon Attack if it is successful. If the Attack misses, the Berzerker loses the HP anyway.", size: "normal" },
        { name: "Taunt", desc: "As an Action, the Berzerker can bellow a challenge at a number of Far Creatures that can see and hear them equal to the Berzerker’s HD.\n\nThe Berzerker makes a CHA Test against each target. On a success, the creature is TAUNTED - it must spend its movement to reach the Berzerker and may only attack the Berzerker until it is attacked by another creature.", size: "normal" },
        { name: "Dominate the Weak", desc: "As a Reaction, the Berzerker can make a Strength Attribute Test to Attack a Close intelligent enemy that failed its Morale Test. If that Attack reduces the enemy to 0 HP, the Berzerker can choose to restore that enemy to 1 HP and Dominate it. (Max HD up to half the Berzerker's Level, rounded down).\n\nA Dominated enemy becomes a hireling of no cost. After a Long Rest, the Berzerker rolls a CHA Test against them or they flee. They fight for you out of fear but have Disadvantage on Morale Tests.", size: "large" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Sentinel": [
        { name: "Innate Ability 1", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 2", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 3", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Assassin": [
        { name: "Assassinate", desc: "As long as the Assassin is hidden, flanking, or attacking from altitude, the Damage from their Weapon Attacks is doubled. On a critical hit, their Damage is tripled instead. The Assassin can use the Downtime Focus Acquire Assassin’s Contract in order to receive extra coin for killing a Boss Creature they know about.\n\nIf the Assassin lands a kill on an Assassinate, they gain an extra movement Action. If the Assassin kills a Boss creature with an Assassinate, their Doom Die is also reset to Ud6.", size: "large" },
        { name: "Highway Robbery", desc: "During Downtime, the Assassin can stalk the outskirts of a settlement and ambush travelers. Choose a target tier (Commoners, Merchants, Nobility). Make the DEX Test for your tier.\n\nOn success, roll the Focus Usage Die. Multiply the result by the tier rate to receive coins. On a 1 or 2, the die degrades a step. On failure, the Assassin is identified and gains the WANTED Bond.", size: "large" },
        { name: "Duck and Roll", desc: "When the Assassin would take Damage from an area effect, they can use their Reaction to move to a Nearby location. This movement can provoke Opportunity Attacks. If this movement places them outside the area of effect, they take half damage instead. If they remain inside the area, they take full damage.", size: "normal" },
        { name: "Never Caught Off Guard", desc: "The Assassin cannot be Flanked and Defends against Attacks of Opportunity with ADVANTAGE. Also, the Assassin can never be GRAPPLED or STUCK. The Assassin has ADVANTAGE to escaping non-magical restraints. Finally, the Assassin can spend one Minute to create Thieves Tools (Ud4) for 200c.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Grappler": [
        { name: "Innate Ability 1", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 2", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 3", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Beastmaster": [
        { name: "Establish Beast Bond", desc: "Once per day when the Beastmaster personally reduces a Beast to 0 HP, they can choose to spend 100c x Creature HD to attempt to Establish a Beast Bond. The Beastmaster can only tame a Beast that is equal to or less to their own HD.\n\nBonded Beasts are animal Allies permanently bound to the Beastmaster. The Beastmaster can have one Bonded Beast until Level 6. At Level 6, they can have two. Their combined HD must be equal to or less than the Beastmaster's own HD. Bonded Beasts do not roll Initiative and act at the beginning of the Beastmaster's Turn.", size: "large" },
        { name: "Command Bonded Beast", desc: "At 1st Level, the Beastmaster can learn one new Trick. In order to learn a new Trick, the Beastmaster must Learn a Trick during Downtime. Instead of using their Movement, the Beastmaster can make one of their Bonded Beasts perform a Trick. This does not cost the Bonded Beast their Action or Movement.", size: "normal" },
        { name: "Watchful Team", desc: "If the Beastmaster is assigned to Camp Watch, all of their Bonded Beasts also make Camp Watch Tests.", size: "normal" },
        { name: "Pack Attack", desc: "When a Bonded Beast successfully Attacks a creature that is Close to you, you may use your Reaction to make a Melee Weapon Attack against that creature.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Shapeshifter": [
        { name: "Innate Ability 1", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 2", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 3", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Maledictor": [
        { name: "Cast Judgement", desc: "The Maledictor can issue a judgement against a foe. [Full rules pending in V3 document.]", size: "normal" },
        { name: "Innate Ability 2", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 3", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Tactician": [
        { name: "Ribald Mockery", desc: "Once per Round, after the Tactician deals Damage to an intelligent enemy with a Melee Weapon Attack, they can choose to make a Cutting Jibe.\n\nTo make a Cutting Jibe, they can recite a bespoke or pre-written insult and make a CHA Test. On a success, the total Damage is doubled.", size: "normal" },
        { name: "Devise and Enact Stratagem", desc: "At 1st Level, the Tactician can learn one Stratagem. In order to learn a new Stratagem, the Tactician must spend their Downtime Focus on the Devise Stratagem.\n\nInstead of using their Movement, the Tactician can make one of the other Player Characters or Allies perform a Stratagem.", size: "normal" },
        { name: "Troupe Leader", desc: "Something that makes mercenary hirelings cheaper? [TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Physician": [
        { name: "Life Siphon", desc: "When the Physician makes a successful Melee Weapon Attack against any target, they can immediately choose one Nearby PC or Ally to heal for 1 HP per HD of the Physician.", size: "normal" },
        { name: "Field Triage", desc: "When the Party completes a Short Rest, the Physician may roll a Healer’s Kit Usage Die and treat one PC or Ally. If that creature recovers HP by rolling Hit Dice, treat one of those dice as having rolled its maximum result.\n\nWhen the Party completes a Long Rest, the Physician may perform Field Triage instead of recovering HP normally. The Physician recovers half of their maximum HP (rounded up), and one PC or Ally recovers HP to their maximum. The Physician cannot be assigned to Camp Watch if Camping.", size: "large" },
        { name: "The Edge of Death", desc: "When a Nearby PC or Ally rolls on the OofA table, the Physician can spend Inspiration or degrade their Doom Die to allow that PC or Ally to re-roll on the Out of Action table and choose which result to keep.", size: "normal" },
        { name: "Preserve Corpse", desc: "The Physician may spend an Hour working on an intact corpse and roll a Healer’s Kit Usage Die. On completion, the corpse is preserved. A preserved corpse does not decay and is always treated as fresh and intact for the purposes of Thanatomancy and any reanimation effects.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Architect": [
        { name: "Efficient Construction", desc: "The Architect does not need to roll an Attribute Test to cast spells in the Artifice school outside of combat. Also, the cost associated with Artifice spells outside of combat is halved. PC and Allies have ADVANTAGE when using or interacting with structures created by the Architect.\n\nAt 5th Level, structures created by the Architect have twice as much HP. At 10th Level, structures have ten times as much HP.", size: "large" },
        { name: "Salvaging", desc: "After settling and divvying the results of a Loot Test on a Boss, the Architect can count up the number of 1s rolled on that Loot Test and re-roll them, adding the additional results to their own purse and rolling for any additional Treasures.", size: "normal" },
        { name: "Stonecunning", desc: "The Architect doubles total Damage against any Automata or objects made of natural building materials.", size: "normal" },
        { name: "Square Posture", desc: "The Architect can use the Guard Maneuver instead of their Movement.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Magician": [
        { name: "Mundane Ward", desc: "After a Long Rest, the Magician can choose to roll their Spell Component Usage Die again in order to gain +1 Ward AV. This Ward lasts until the next Long Rest or until it is destroyed. This Ward does not stack with others and is replaced if a higher quantity Ward is active.", size: "normal" },
        { name: "Spellburn", desc: "When you fail a Memory Test to retain a spell, they may choose to take Force Damage equal to the HD of the spell. If they do, the Memory Test is treated as a success and the spell remains Memorized (and Strained).", size: "normal" },
        { name: "Eidetic Autodidact", desc: "Magician can learn spells in downtime by sacrificing scrolls. [TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Mystic": [
        { name: "Occult Antiquarian", desc: "Has 6 attunements, can lend attuned items to other characters. Also, you can ready 2 scrolls in addition to the 2 readied items a class is allowed.", size: "normal" },
        { name: "Weirdsense", desc: "Can see invisible creatures and also can keep auditory communication lines between friendly creatures within distant. The mystic casts an aura wherein all allies can hear and understand one another's thoughts.", size: "normal" },
        { name: "Scroll Master", desc: "The Mystic does not follow the ordinary rules regarding Scrolls:\n• They can cast spells from Scrolls of any Magical School.\n• They can ready two scrolls in addition to the 2 readied items normally allowed.\n• They can cast spells from Scrolls even while wielding LARGE, REACH, DUAL, or RANGED Weapons, so long as they expend both their Action and their Movement to do it.", size: "large" },
        { name: "Battle Caster", desc: "The Mystic’s Damage Die becomes d6 when they are using a Magical Weapon. The Mystic can use their WIS when Attacking and Defending. When Attacking with a Magical Weapon, the Mystic has Advantage against Aberrations.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Dilettante": [
        { name: "Profligate Gambling", desc: "During Downtime, the Dilettante can gain access to exclusive gaming clubs. Choose a Table Tier at the outset. Pay the Buy-In to begin. Make the CHA Test for the selected tier. On success, roll the Focus Usage Die and multiply by the tier rate to receive coins. On failure, the Buy-In is lost.", size: "large" },
        { name: "Call in a Favor", desc: "Once per Day, you may declare a plausible past event that nullifies, bypasses, or accelerates the current obstacle. Make a CHA Test. On a success, the preparation is real, at no additional cost. On a failure, it is real but you must pay HD × 100 coin. On a critical failure, the action fails and you must pay HD x 100 (or go into debt).", size: "normal" },
        { name: "Persuasive Rhetoric", desc: "The Dilettante can cast Communion school spells without being detected, using their natural speech and mannerisms to do so. When casting unmemorized Communion spells out of combat, the Dilettante does not need to roll on the Spell Misfires table if the Spell Attribute Test fails.", size: "normal" },
        { name: "Master Manipulator", desc: "Once per Round, when the Dilettante is targeted by an Attack, they can use their Reaction to make a CHA Test. On a success, the attack is redirected to another ally within range of the attacker. If no ally is within range, the attack proceeds normally. This does not work against creatures immune to Charm effects.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Diabolist": [
        { name: "Bind Retinue", desc: "The Diabolist may spend one Minute performing a binding ritual on demons they have personally summoned. Bound creatures require no concentration, follow the binder’s commands absolutely, and cannot be banished. A bound creature persists until it is destroyed, dismissed, or the Diabolist is knocked Out of Action.\n\nWhen a bound creature is reduced to 0 HP, the Diabolist may immediately forget one memorized spell to restore that Creature to 1 HP.", size: "large" },
        { name: "Minion Conduit", desc: "The Diabolist’s bound creatures can serve as extensions for their own spellcasting:\n• As an Action, you may cast any memorized spell as if its point of origin were your bound minion.\n• As a Reaction, when you or a Close ally would take damage, you may destroy a minion to completely negate the damage.\n• As an Action, destroy a minion to regain a memorized spell of a level equal to or less than the minion’s HD.", size: "large" },
        { name: "Extraplanar Correspondence", desc: "After a Long Rest, the Diabolist can pen a minor contract with a lesser extraplanar entity to assist in one service. Roll the Doom Usage Die to gain benefits like granting an additional Downtime Focus roll, Scrying a specific question, or returning a Damaged Armor Die to an Ally.", size: "normal" },
        { name: "The Lash", desc: "The Diabolist can choose to make a full Attack against a Bound creature. If the hit is successful, the creature can make an Extra Attack Action against a Close enemy. If the Attack is a Critical Hit, the Extra Attack is also automatically critical.", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Hierophant": [
        { name: "Innate Ability 1", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 2", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 3", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ],
    "Chanter": [
        { name: "Innate Ability 1", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 2", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 3", desc: "[TBD]", size: "normal" },
        { name: "Innate Ability 4", desc: "[TBD]", size: "normal" },
        { name: "Heroic Ability", desc: "[TBD: Unlocks after completing a Mighty Deed]", size: "normal" }
    ]
};

// Function to update class innate abilities in repeating section
function updateClassInnateAbilities(className) {
    // First, get all ability rows and remove CLASS ones
    getSectionIDs("repeating_abilities", function(idarray) {
        const sourceAttrs = idarray.map(id => "repeating_abilities_" + id + "_ability_source");
        
        getAttrs(sourceAttrs, function(values) {
            // Find and remove CLASS entries
            idarray.forEach(function(id) {
                const source = values["repeating_abilities_" + id + "_ability_source"];
                if (source === "CLASS") {
                    removeRepeatingRow("repeating_abilities_" + id);
                }
            });
            
            // Now add new class ability entries
            const abilities = CLASS_INNATE_ABILITIES[className] || [];
            abilities.forEach(function(ability) {
                const newRowId = generateRowID();
                const newAttrs = {};
                newAttrs["repeating_abilities_" + newRowId + "_ability_source"] = "CLASS";
                newAttrs["repeating_abilities_" + newRowId + "_ability_name"] = ability.name;
                newAttrs["repeating_abilities_" + newRowId + "_ability_desc"] = ability.desc;
                newAttrs["repeating_abilities_" + newRowId + "_ability_size"] = ability.size || "normal";
                setAttrs(newAttrs);
            });
        });
    });
}

// On class change: set HD, damage_die, damage_prog, actions AND update expertise
on("change:class", function() {
    getAttrs(["class"], function(values) {
        const className = values.class || "";
        const classInfo = CLASS_DATA[className];
        const classActions = CLASS_ACTIONS[className];
        const classLeveling = CLASS_LEVELING[className];
        
        const updates = {};
        
        if (classInfo) {
            updates.hd = classInfo.hd;
            updates.damage_die = classInfo.damage;
            updates.damage_prog = classInfo.prog;
        }
        
        // Set actions (or clear if no class)
        if (classActions) {
            updates.noble_stability = classActions.stability;
            updates.noble_change = classActions.change;
            updates.ignoble = classActions.ignoble;
        } else {
            updates.noble_stability = "—";
            updates.noble_change = "—";
            updates.ignoble = "—";
        }
        
        // Set leveling rules in Experience Ledger
        if (classLeveling) {
            updates.level_up_desc = classLeveling;
        } else {
            updates.level_up_desc = "";
        }
        
        setAttrs(updates);
        
        // Update class expertise and innate abilities
        updateClassExpertise(className);
        updateClassInnateAbilities(className);
    });
});

// Function to update class expertise in repeating section
function updateClassExpertise(className) {
    // First, get all expertise rows and remove CLASS ones
    getSectionIDs("repeating_expertise", function(idarray) {
        // Build attribute names to fetch
        const sourceAttrs = idarray.map(id => "repeating_expertise_" + id + "_expertise_source");
        
        getAttrs(sourceAttrs, function(values) {
            // Find and remove CLASS entries
            const removeUpdate = {};
            idarray.forEach(function(id) {
                const source = values["repeating_expertise_" + id + "_expertise_source"];
                if (source === "CLASS") {
                    removeRepeatingRow("repeating_expertise_" + id);
                }
            });
            
            // Now add new class expertise entries
            const expertise = CLASS_EXPERTISE[className] || [];
            expertise.forEach(function(desc) {
                const newRowId = generateRowID();
                const newAttrs = {};
                newAttrs["repeating_expertise_" + newRowId + "_expertise_source"] = "CLASS";
                newAttrs["repeating_expertise_" + newRowId + "_expertise_modifier"] = "Advantage";
                newAttrs["repeating_expertise_" + newRowId + "_expertise_desc"] = desc;
                setAttrs(newAttrs);
            });
        });
    });
}

// Calculate damage display and rest HD counts based on level and class
function calculateDamageAndRest() {
    getAttrs(["level", "damage_die", "damage_prog"], function(values) {
        const level = parseInt(values.level) || 1;
        const damageDie = values.damage_die || "d6";
        const prog = values.damage_prog || "None";
        
        let damageDisplay = "";
        
        switch(prog) {
            case "per HD":
                damageDisplay = "Pool: " + level + damageDie;
                break;
            case "per Even":
                // Start with 1, gain another at each even level
                const evenCount = 1 + Math.floor(level / 2);
                damageDisplay = "Pool: " + evenCount + damageDie;
                break;
            case "+HD":
                damageDisplay = "1" + damageDie + "+" + level;
                break;
            case "None":
            default:
                damageDisplay = "1" + damageDie;
                break;
        }
        
        const shortHD = 1;
        const watchHD = Math.ceil(level / 2);
        const longHD = level;
        
        setAttrs({
            damage_display: damageDisplay,
            rest_hd_short: shortHD,
            rest_hd_watch: watchHD,
            rest_hd_long: longHD
        });
    });
}

on("change:level change:damage_die change:damage_prog sheet:opened", function() {
    calculateDamageAndRest();
});

// Mystic Magical Weapon override — d4/None becomes d8/per Even
on("change:weapon_mystic_override change:class", function() {
    getAttrs(["class", "weapon_mystic_override"], function(values) {
        if (values.class !== "Mystic") return;
        
        const override = values.weapon_mystic_override === "1";
        setAttrs({
            damage_die: override ? "d8" : "d4",
            damage_prog: override ? "per Even" : "None"
        });
    });
});
// ==========================================
// 1. TAB & INITIALIZATION LOGIC
// ==========================================
// Sync the visual tabs with the hidden logic
on("change:view_tab", function(eventInfo) {
    setAttrs({
        sheettype: eventInfo.newValue
    });
});
// Initialize sheet (calculate stats on open)
on("sheet:opened", function() {
    getAttrs(["sheettype", "int"], function(values) {
        const type = values.sheettype || "pc";
        const intVal = parseInt(values.int) || 10;
        const maxSpells = Math.max(0, intVal - 10);
        setAttrs({
            view_tab: type,
            spells_max: maxSpells
        });
    });
    // Recalculate Armor on open just in case
    calculateArmorPool();
});
// Update Spell Slots when INT changes
on("change:int", function() {
    getAttrs(["int"], function(values) {
        const intVal = parseInt(values.int) || 10;
        const maxSpells = Math.max(0, intVal - 10);
        setAttrs({ spells_max: maxSpells });
    });
});
// ==========================================
// 2. ARMOR SYSTEM (Redesigned)
// ==========================================

// Calculate total armor pool
function calculateArmorPool() {
    getAttrs(["armor_av"], function(values) {
        const armorAV = parseInt(values.armor_av) || 0;
        
        setAttrs({ 
            armor_pool_total: armorAV,
            av_total: armorAV
        });
    });
}

// On sheet open, just update the pool display
on("sheet:opened", function() {
    calculateArmorPool();
});

// When Armor AV changes, reset to fresh armor (Available = AV, Damaged/Destroyed = 0)
on("change:armor_av", function() {
    getAttrs(["armor_av"], function(values) {
        const armorAV = parseInt(values.armor_av) || 0;
        
        setAttrs({ 
            armor_pool_total: armorAV,
            av_total: armorAV,
            armor_pool_available: armorAV,
            armor_pool_damaged: 0,
            armor_pool_destroyed: 0
        });
    });
});

// Ward buttons (unchanged - ward is separate from armor pool)
on("clicked:ward_plus", function() {
    getAttrs(["ward_av", "ward_av_max"], function(values) {
        const current = parseInt(values.ward_av) || 0;
        const max = parseInt(values.ward_av_max) || 0;
        if (current < max) {
            setAttrs({ ward_av: current + 1 });
        }
    });
});

on("clicked:ward_minus", function() {
    getAttrs(["ward_av"], function(values) {
        const current = parseInt(values.ward_av) || 0;
        if (current > 0) {
            setAttrs({ ward_av: current - 1 });
        }
    });
});

on("change:ward_av_max", function() {
    getAttrs(["ward_av", "ward_av_max"], function(values) {
        const current = parseInt(values.ward_av) || 0;
        const max = parseInt(values.ward_av_max) || 0;
        if (current > max) {
            setAttrs({ ward_av: max });
        }
    });
});

// Pool Available +/- buttons
on("clicked:pool_plus", function() {
    getAttrs(["armor_pool_available", "armor_pool_total", "armor_pool_damaged", "armor_pool_destroyed"], function(values) {
        const available = parseInt(values.armor_pool_available) || 0;
        const total = parseInt(values.armor_pool_total) || 0;
        const damaged = parseInt(values.armor_pool_damaged) || 0;
        const destroyed = parseInt(values.armor_pool_destroyed) || 0;
        
        // Max available is pool minus destroyed
        const maxAvailable = total - destroyed;
        
        // Can only add if: available < maxAvailable AND we have damaged dice to restore
        if (available < maxAvailable && damaged > 0) {
            setAttrs({ 
                armor_pool_available: available + 1,
                armor_pool_damaged: damaged - 1
            });
        } else if (available < maxAvailable) {
            // Allow manual increase for setup
            setAttrs({ armor_pool_available: available + 1 });
        }
    });
});

on("clicked:pool_minus", function() {
    getAttrs(["armor_pool_available", "armor_pool_damaged"], function(values) {
        const available = parseInt(values.armor_pool_available) || 0;
        const damaged = parseInt(values.armor_pool_damaged) || 0;
        
        if (available > 0) {
            setAttrs({ 
                armor_pool_available: available - 1,
                armor_pool_damaged: damaged + 1
            });
        }
    });
});

// BREAK ARMOR DIE BUTTON
// First subtracts from Ward, then from armor pool (Available -> Damaged)
on("clicked:break_armor", function() {
    getAttrs(["ward_av", "armor_pool_available", "armor_pool_damaged"], function(values) {
        const wardVal = parseInt(values.ward_av) || 0;
        const available = parseInt(values.armor_pool_available) || 0;
        const damaged = parseInt(values.armor_pool_damaged) || 0;
        
        // Try Ward first
        if (wardVal > 0) {
            setAttrs({ ward_av: wardVal - 1 });
            return;
        }
        
        // Then armor pool
        if (available > 0) {
            setAttrs({ 
                armor_pool_available: available - 1,
                armor_pool_damaged: damaged + 1
            });
        }
    });
});

// REPAIR ARMOR BUTTON (Rest)
// Roll repair pool (damaged + helmet + shield) d6, must beat Armor AV
// Each success repairs one damaged die (capped at # damaged)
// Remaining damaged dice become destroyed
on("clicked:repair_armor", function() {
    getAttrs(["character_name", "armor_name", "armor_av", "helmet_dice", "shield_dice", "armor_pool_available", "armor_pool_damaged", "armor_pool_destroyed"], function(values) {
        const charName = values.character_name || "Unknown";
        const armorName = values.armor_name || "Armor";
        const av = parseInt(values.armor_av) || 0;
        const helmetDice = parseInt(values.helmet_dice) || 0;
        const shieldDice = parseInt(values.shield_dice) || 0;
        const available = parseInt(values.armor_pool_available) || 0;
        const damaged = parseInt(values.armor_pool_damaged) || 0;
        const destroyed = parseInt(values.armor_pool_destroyed) || 0;
        
        if (damaged === 0) {
            startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Repair " + armorName + "}} {{description=No damaged dice to repair.}}", function(results) {
                finishRoll(results.rollId, {});
            });
            return;
        }
        
        if (av === 0) {
            startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Repair " + armorName + "}} {{description=Armor AV is 0 - all damaged dice restored.}}", function(results) {
                finishRoll(results.rollId, {});
            });
            setAttrs({ 
                armor_pool_available: available + damaged,
                armor_pool_damaged: 0
            });
            return;
        }
        
        // Repair pool = damaged + helmet + shield
        const repairPool = damaged + helmetDice + shieldDice;
        const rollFormula = repairPool + "d6";
        
        startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Repair " + armorName + "}} {{roll=[[" + rollFormula + "]]}} {{target=[[" + av + "]]}}", function(results) {
            const rolls = results.results.roll.dice;
            let successes = 0;
            let rollDetails = [];
            
            rolls.forEach(function(roll) {
                if (roll > av) {
                    successes++;
                    rollDetails.push(roll + "✓");
                } else {
                    rollDetails.push(roll + "✗");
                }
            });
            
            // Repairs capped at number of damaged dice
            const repaired = Math.min(successes, damaged);
            const newDestroyed = damaged - repaired;
            
            // Update the armor pool
            const newAvailable = available + repaired;
            const totalDestroyed = destroyed + newDestroyed;
            setAttrs({ 
                armor_pool_available: newAvailable,
                armor_pool_damaged: 0,
                armor_pool_destroyed: totalDestroyed
            });
            
            finishRoll(results.rollId, {});
            
            // Post results
            let poolNote = "";
            if (helmetDice > 0 || shieldDice > 0) {
                poolNote = "Pool: " + damaged + " damaged";
                if (helmetDice > 0) poolNote += " + " + helmetDice + " helm";
                if (shieldDice > 0) poolNote += " + " + shieldDice + " shield";
                poolNote += "\n";
            }
            const resultText = poolNote + "Rolls: " + rollDetails.join(", ") + " (beat " + av + ")\n\n" + repaired + " REPAIRED, " + newDestroyed + " DESTROYED";
            startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Repair Results}} {{description=" + resultText + "}}", function(r2) {
                finishRoll(r2.rollId, {});
            });
        });
    });
});

// SETTLEMENT REPAIR BUTTON
// Clear destroyed dice and display repair cost
on("clicked:settlement_repair", function() {
    getAttrs(["character_name", "armor_name", "armor_av", "armor_pool_available", "armor_pool_destroyed"], function(values) {
        const charName = values.character_name || "Unknown";
        const armorName = values.armor_name || "Armor";
        const av = parseInt(values.armor_av) || 0;
        const available = parseInt(values.armor_pool_available) || 0;
        const destroyed = parseInt(values.armor_pool_destroyed) || 0;
        
        if (destroyed === 0) {
            startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Settlement Repair}} {{description=No destroyed dice to repair.}}", function(results) {
                finishRoll(results.rollId, {});
            });
            return;
        }
        
        // Calculate cost formula based on AV
        let costFormula = "";
        let costDesc = "";
        if (av <= 1) {
            costFormula = destroyed + "d8";
            costDesc = destroyed + "d8";
        } else if (av === 2) {
            costFormula = (destroyed * 2) + "d8+" + (destroyed * 5);
            costDesc = (destroyed * 2) + "d8 + " + (destroyed * 5);
        } else if (av === 3) {
            costFormula = (destroyed * 3) + "d8+" + (destroyed * 5);
            costDesc = (destroyed * 3) + "d8 + " + (destroyed * 5);
        } else if (av === 4) {
            costFormula = (destroyed * 4) + "d8+" + (destroyed * 10);
            costDesc = (destroyed * 4) + "d8 + " + (destroyed * 10);
        } else {
            costFormula = (destroyed * 5) + "d8+" + (destroyed * 10);
            costDesc = (destroyed * 5) + "d8 + " + (destroyed * 10);
        }
        
        // Roll cost and restore dice
        startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Settlement Repair: " + armorName + "}} {{roll=[[" + costFormula + "]]}} {{description=Repaired " + destroyed + " destroyed dice.\nCost: " + costDesc + " gold}}", function(results) {
            // Restore destroyed dice to available
            setAttrs({ 
                armor_pool_available: available + destroyed,
                armor_pool_destroyed: 0
            });
            
            finishRoll(results.rollId, {});
        });
    });
});

// CLAN AID BUTTON
// Rolls standing die and outputs result with degradation warning
on("clicked:clan_aid", function() {
    getAttrs(["standing_die", "character_name", "clan_name"], function(values) {
        const die = values.standing_die || "d8";
        const charName = values.character_name || "Unknown";
        const clanName = values.clan_name || "Clan";
        
        if (die === "0") {
            startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Request Aid: " + clanName + "}} {{note=You lack standing and cannot request aid.}}", function(results) {
                finishRoll(results.rollId, {});
            });
        } else {
            startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Request Aid: " + clanName + "}} {{roll=[[1" + die + "cs0cf0]]}} {{note=On 1-2, degrade Standing one step.}}", function(results) {
                finishRoll(results.rollId, {});
            });
        }
    });
});
// WEAPON STAT TARGET SYNC
// ==========================================
// Update weapon targets when STR or DEX changes
on("change:str change:dex", function() {
    getAttrs(["weapon1_stat", "weapon2_stat", "weapon3_stat", "str", "dex"], function(values) {
        const str = parseInt(values.str) || 10;
        const dex = parseInt(values.dex) || 10;
        const update = {};
        
        ["weapon1", "weapon2", "weapon3"].forEach(function(weapon) {
            const stat = values[weapon + "_stat"] || "str";
            update[weapon + "_target"] = (stat === "dex") ? dex : str;
        });
        
        setAttrs(update);
    });
});

// ==========================================
// WEAPON PROPERTY LOGIC
// ==========================================
// Update range display and stat based on weapon properties
["weapon1", "weapon2", "weapon3"].forEach(function(weapon) {
    const propAttrs = [weapon + "_light", weapon + "_thrown", weapon + "_ranged", weapon + "_reach"];
    const propListenString = propAttrs.map(function(a) { return "change:" + a; }).join(" ");
    
    on(propListenString + " change:weapon_mystic_override change:wis sheet:opened", function() {
        getAttrs(propAttrs.concat(["str", "dex", "wis", "weapon_mystic_override"]), function(values) {
            const light = values[weapon + "_light"] === "on";
            const thrown = values[weapon + "_thrown"] === "on";
            const ranged = values[weapon + "_ranged"] === "on";
            const reach = values[weapon + "_reach"] === "on";
            const mysticOverride = values.weapon_mystic_override === "1";
            
            // Determine range (prefer longest)
            let range = "Close 5'";
            if (reach) range = "Reach 10'";
            if (thrown) range = "Nearby 30'";
            if (ranged) range = "Far 120'";
            
            // Determine stat — Mystic override trumps everything
            let stat, statDisplay;
            if (mysticOverride) {
                stat = "wis";
                statDisplay = "WIS";
            } else {
                const useDex = light || ranged;
                stat = useDex ? "dex" : "str";
                statDisplay = useDex ? "DEX" : "STR";
            }
            const targetValue = parseInt(values[stat]) || 10;
            
            // Update attributes
            const update = {};
            update[weapon + "_range_display"] = range;
            update[weapon + "_stat"] = stat;
            update[weapon + "_stat_display"] = statDisplay;
            update[weapon + "_target"] = targetValue;
            setAttrs(update);
        });
    });
});

// Weapon attack action handlers
["weapon1", "weapon2", "weapon3"].forEach(function(weapon) {
    on("clicked:" + weapon + "_attack", function() {
        const attrs = [
            "character_name", weapon + "_name", weapon + "_target",
            weapon + "_large", weapon + "_light", weapon + "_thrown", weapon + "_ranged",
            weapon + "_reach", weapon + "_steel", weapon + "_keen", weapon + "_magic",
            weapon + "_holy", weapon + "_silver", weapon + "_dual", weapon + "_master",
            weapon + "_notes", weapon + "_range_display", weapon + "_stat_display",
            weapon + "_bonus", "damage_die", "damage_prog", "level"
        ];
        
        getAttrs(attrs, function(values) {
            const charName = values.character_name || "Unknown";
            const weaponName = values[weapon + "_name"] || "Weapon";
            const target = values[weapon + "_target"] || 10;
            const notes = values[weapon + "_notes"] || "";
            const range = values[weapon + "_range_display"] || "Close 5'";
            const statDisplay = values[weapon + "_stat_display"] || "STR";
            
            // Get damage info from identity
            const damageDie = values.damage_die || "d6";
            const dieNum = damageDie.replace("d", "");
            const prog = values.damage_prog || "Fixed";
            const level = parseInt(values.level) || 1;
            const bonus = parseInt(values[weapon + "_bonus"]) || 0;
            
            // Check properties
            const large = values[weapon + "_large"] === "on";
            const dual = values[weapon + "_dual"] === "on";
            const steel = values[weapon + "_steel"] === "on";
            const keen = values[weapon + "_keen"] === "on";
            const magic = values[weapon + "_magic"] === "on";
            const holy = values[weapon + "_holy"] === "on";
            const silver = values[weapon + "_silver"] === "on";
            const master = values[weapon + "_master"] === "on";
            
            // Build property tags for display
            let propTags = [];
            if (large) propTags.push("Large (+1d4/die)");
            if (dual) propTags.push("Dual (+1d4/die)");
            if (steel) propTags.push("Steel");
            if (keen) propTags.push("Keen");
            if (magic) propTags.push("Magic");
            if (holy) propTags.push("Holy");
            if (silver) propTags.push("Silver");
            if (master) propTags.push("Master");
            
            // Calculate damage formula based on progression type
            let damageFormula = "";
            let diceQuery = "";
            
            if (prog === "per HD") {
                // Pool = level dice, player chooses how many to use
                diceQuery = "?{How many Damage Dice? (Pool: " + level + ")|" + level + "}";
                damageFormula = diceQuery + "d" + dieNum;
                if (bonus !== 0) damageFormula += "+" + diceQuery + "*" + bonus;
                if (large || dual) damageFormula += "+" + diceQuery + "d4";
            } else if (prog === "per Even") {
                // Pool = 1 + floor(level/2) dice
                const maxDice = 1 + Math.floor(level / 2);
                diceQuery = "?{How many Damage Dice? (Pool: " + maxDice + ")|" + maxDice + "}";
                damageFormula = diceQuery + "d" + dieNum;
                if (bonus !== 0) damageFormula += "+" + diceQuery + "*" + bonus;
                if (large || dual) damageFormula += "+" + diceQuery + "d4";
            } else if (prog === "+HD") {
                damageFormula = "1d" + dieNum + "+" + level;
                if (bonus !== 0) damageFormula += "+" + bonus;
                if (large || dual) damageFormula += "+1d4";
            } else {
                // "None" or anything else: just 1 die, no query
                damageFormula = "1d" + dieNum;
                if (bonus !== 0) damageFormula += "+" + bonus;
                if (large || dual) damageFormula += "+1d4";
            }
            
            // Build property note line
            let propNote = range + " / " + statDisplay;
            if (propTags.length > 0) propNote += " | " + propTags.join(", ");
            if (notes) propNote += " | " + notes;
            
            // Build special effects reminder
            let effects = [];
            if (steel) effects.push("STEEL: Breaks 1 AV on hit");
            if (keen) effects.push("KEEN: Ignores DR; Crit on 1-3");
            if (magic) effects.push("MAGIC: Ignores Non-Magical Resistance");
            if (holy) effects.push("HOLY: Radiant damage; x2 vs Undead/Demons");
            if (silver) effects.push("SILVER: x2 vs Aberrations/Shapeshifters");
            if (master) effects.push("MASTER: x3 Crit Damage");
            const effectNote = effects.length > 0 ? effects.join(" | ") : "";
            
            // Build roll string
            let rollString = "&{template:birdhack} {{character_name=" + charName + "}} {{name=" + weaponName + " Attack}} {{target=[[" + target + "]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{damage=[[" + damageFormula + "cs0cf0]]}} {{type=attack}} {{reminder=*Adjust for Powerful Foe}} {{notes=" + propNote + "}}";
            
            if (effectNote) {
                rollString = "&{template:birdhack} {{character_name=" + charName + "}} {{name=" + weaponName + " Attack}} {{target=[[" + target + "]]}} {{roll=[[?{Roll Type|Normal,1d20cf20cs1|Advantage,2d20kl1cf20cs1|Disadvantage,2d20kh1cf20cs1}]]}} {{damage=[[" + damageFormula + "cs0cf0]]}} {{type=attack}} {{notes=" + propNote + "}} {{reminder=" + effectNote + "}}";
            }
            
            startRoll(rollString, function(results) {
                finishRoll(results.rollId, {});
            });
        });
    });
});
// ==========================================
// NPC TARGET CALCULATION (Target = 9 + HD)
// ==========================================
on("change:npc_hd sheet:opened", function() {
    getAttrs(["npc_hd"], function(values) {
        const hd = parseInt(values.npc_hd) || 1;
        const target = 9 + hd;
        setAttrs({
            npc_target: target,
            npc_target_display: target
        });
    });
});

// Sync creature type selector with radio buttons
on("change:npc_creature_type_select", function() {
    getAttrs(["npc_creature_type_select"], function(values) {
        setAttrs({
            npc_creature_type: values.npc_creature_type_select
        });
    });
});

// ==========================================
// NPC DAMAGE TYPE TOGGLE (Cycles: Normal -> Resistant -> Vulnerable -> Immune)
// ==========================================
["bludgeoning", "slashing", "piercing", "fire", "cold", "lightning", "acid", "thunder", "force", "psychic", "necrotic", "radiant", "poison"].forEach(function(dmg) {
    on("clicked:toggle_" + dmg, function() {
        getAttrs(["npc_dmg_" + dmg], function(values) {
            let current = parseInt(values["npc_dmg_" + dmg]) || 0;
            let next = (current + 1) % 4; // cycles 0 -> 1 -> 2 -> 3 -> 0
            let update = {};
            update["npc_dmg_" + dmg] = next;
            setAttrs(update);
        });
    });
});

// PC DAMAGE TYPE TOGGLE (Cycles: Normal -> Resistant -> Vulnerable -> Immune)
// ==========================================
["bludgeoning", "slashing", "piercing", "fire", "cold", "lightning", "acid", "thunder", "force", "psychic", "necrotic", "radiant", "poison"].forEach(function(dmg) {
    on("clicked:pc_toggle_" + dmg, function() {
        getAttrs(["pc_dmg_" + dmg], function(values) {
            let current = parseInt(values["pc_dmg_" + dmg]) || 0;
            let next = (current + 1) % 4; // cycles 0 -> 1 -> 2 -> 3 -> 0
            let update = {};
            update["pc_dmg_" + dmg] = next;
            setAttrs(update);
        });
    });
});

// ==========================================
// NPC LOOT ROLLER (prompts for Boss)
// ==========================================
on("clicked:npc_loot", function() {
    getAttrs(["npc_hd", "npc_name"], function(values) {
        const hd = parseInt(values.npc_hd) || 1;
        const name = values.npc_name || "NPC";
        
        // Use Roll20 query for Boss prompt
        const rollStr = `&{template:birdhack} {{character_name=${name}}} {{name=LOOT}} {{roll=[[(?{Boss?|No,1|Yes,10}*${hd})d6]]}} {{computed::treasures=[[0]]}} {{note=Roll on Treasure Table for each Treasure found}}`;
        
        startRoll(rollStr, function(results) {
            const dice = results.results.roll.dice;
            const total = results.results.roll.result;
            const treasures = dice.filter(function(d) { return d === 6; }).length;
            
            finishRoll(results.rollId, {
                treasures: treasures
            });
        });
    });
});

// ==========================================
// ==========================================
// 2c. DEITY FILTER FOR ASPECTS
// ==========================================
const DEITY_TO_FILTER = {
    "Hnálla": "hnalla",
    "Drá": "dra",
    "Karakán": "karakan",
    "Chegárra": "chegarra",
    "Thúmis": "thumis",
    "Keténgku": "ketengku",
    "Avánthe": "avanthe",
    "Dilinála": "dilinala",
    "Belkhánu": "belkhanu",
    "Qón": "qon",
    "Hrü'ü": "hruu",
    "Wurú": "wuru",
    "Vimúhla": "vimuhla",
    "Chiténg": "chiteng",
    "Ksárul": "ksarul",
    "Grugánu": "gruganu",
    "Dlamélish": "dlamelish",
    "Hriháyal": "hrihayal",
    "Sárku": "sarku",
    "Durritlámish": "durritlamish",
    "The Other One": "pariahother",
    "The Goddess of the Pale Bone": "pariahbone",
    "The One Who Is": "pariahone"
};

on("change:deity", function() {
    getAttrs(["deity"], function(values) {
        const deity = values.deity || "";
        const filterValue = DEITY_TO_FILTER[deity] || "";
        setAttrs({
            deity_filter: filterValue,
            aspect: ""  // Clear aspect when deity changes
        });
    });
});

// INITIATIVE ROLL (Black Hack style - roll under DEX)
on("clicked:initiative", function() {
    getAttrs(["character_name"], function(values) {
        const charName = values.character_name || "Unknown";
        
        startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Initiative}} {{target=[[@{dex} + @{initiative_bonus}]]}} {{roll=[[1d20cs0cf0]]}} {{note=Roll UNDER target to act BEFORE enemies}}", function(results) {
            finishRoll(results.rollId);
        });
    });
});

// 3. REST MECHANICS
// ==========================================
// Short Rest: Roll 1 HD
on("clicked:short_rest", function() {
    startRoll("&{template:birdhack} {{name=Short Rest}} {{roll=[[@{hd}cs0cf0]]}} {{note=Heals 1 HD}}", function(results) {
        const hdRoll = results.results.roll.result;
        getAttrs(["hp", "hp_max"], function(values) {
            const currentHP = parseInt(values.hp) || 0;
            const maxHP = parseInt(values.hp_max) || 8;
            const newHP = Math.min(maxHP, currentHP + hdRoll);
            setAttrs({ hp: newHP });
            finishRoll(results.rollId, {
                roll: hdRoll
            });
        });
    });
});

// Watch Rest: Roll HALF HD (rounded up)
on("clicked:watch_rest", function() {
    getAttrs(["level", "hd", "hp", "hp_max"], function(values) {
        const level = parseInt(values.level) || 1;
        const halfLevel = Math.ceil(level / 2);
        const hdType = values.hd || "d6";
        
        startRoll("&{template:birdhack} {{name=Watch Rest}} {{roll=[[" + halfLevel + hdType + "cs0cf0]]}} {{note=Heals " + halfLevel + " HD (half level)}}", function(results) {
            const hdRoll = results.results.roll.result;
            const currentHP = parseInt(values.hp) || 0;
            const maxHP = parseInt(values.hp_max) || 8;
            const newHP = Math.min(maxHP, currentHP + hdRoll);
            setAttrs({ hp: newHP });
            finishRoll(results.rollId, {
                roll: hdRoll
            });
        });
    });
});

// Long Rest: Roll ALL HD, clear strain
on("clicked:long_rest", function() {
    getAttrs(["level", "hd", "hp", "hp_max"], function(values) {
        const level = parseInt(values.level) || 1;
        const hdType = values.hd || "d6";
        
        startRoll("&{template:birdhack} {{name=Long Rest}} {{roll=[[" + level + hdType + "cs0cf0]]}} {{note=Heals " + level + " HD (full level). Clears strain.}}", function(results) {
            const hdRoll = results.results.roll.result;
            const currentHP = parseInt(values.hp) || 0;
            const maxHP = parseInt(values.hp_max) || 8;
            const newHP = Math.min(maxHP, currentHP + hdRoll);
            setAttrs({ 
                hp: newHP,
                strain: 0,
                hp_temp: 0
            });
            finishRoll(results.rollId, {
                roll: hdRoll
            });
        });
    });
    // Clear "Strained" status from all spells
    getSectionIDs("repeating_spells", function(idarray) {
        const update = {};
        idarray.forEach(function(id) {
            update["repeating_spells_" + id + "_spell_strained"] = 0;
        });
        setAttrs(update);
    });
});
// 4. HIRELING WAGE CALCULATOR
// ==========================================
on("change:repeating_hirelings:hireling_cost change:repeating_hirelings:hireling_qty remove:repeating_hirelings", function() {
    getSectionIDs("repeating_hirelings", function(ids) {
        // Build list of attributes to fetch
        const fieldNames = ids.reduce((acc, id) => {
            acc.push(`repeating_hirelings_${id}_hireling_cost`);
            acc.push(`repeating_hirelings_${id}_hireling_qty`);
            return acc;
        }, []);
        getAttrs(fieldNames, function(values) {
            let totalWages = 0;
            ids.forEach(function(id) {
                const costRaw = values[`repeating_hirelings_${id}_hireling_cost`] || "0";
                const qty = parseInt(values[`repeating_hirelings_${id}_hireling_qty`]) || 0;
                // Regex: Remove anything that IS NOT a number or a decimal point
                const numbersOnly = costRaw.replace(/[^0-9.]/g, '');
                const costVal = parseFloat(numbersOnly) || 0;
                totalWages += (qty * costVal);
            });
            // Update the Total Wages box
            setAttrs({ wages_total: totalWages });
        });
    });
});
// ==========================================
// 5. ASSET UPKEEP CALCULATOR
// ==========================================
on("change:repeating_assets:asset_upkeep remove:repeating_assets", function() {
    getSectionIDs("repeating_assets", function(ids) {
        // Build list of attributes to fetch
        const fieldNames = ids.map(id => `repeating_assets_${id}_asset_upkeep`);
        getAttrs(fieldNames, function(values) {
            let totalUpkeep = 0;
            ids.forEach(function(id) {
                const upkeepRaw = values[`repeating_assets_${id}_asset_upkeep`] || "0";
                // Clean the input to get just numbers
                const numbersOnly = upkeepRaw.replace(/[^0-9.]/g, '');
                const costVal = parseFloat(numbersOnly) || 0;
                totalUpkeep += costVal;
            });
            // Update the Total Upkeep box
            setAttrs({ upkeep_total: totalUpkeep });
        });
    });
});
// ==========================================
// 6. STATUS & DOOM LOGIC (NEW)
// ==========================================
// DOOM SYNC
on("change:doom_die", function(eventInfo) {
    if (eventInfo.newValue === "0") {
        setAttrs({ status_doomed: "on" });
    } else {
        setAttrs({ status_doomed: "0" }); // Uncheck
    }
});
on("change:status_doomed", function(eventInfo) {
    if (eventInfo.newValue === "on") {
        setAttrs({ doom_die: "0" });
    } else {
        // Default back to d6 if unchecked manually
        setAttrs({ doom_die: "d6" });
    }
});
// ATTRIBUTE STATUS HIGHLIGHTING
const stats = ["str", "dex", "con", "int", "wis", "cha"];
const adv_map = {
    "str": ["mighty"],
    "dex": ["nimble"],
    "con": ["vigorous"],
    "int": ["lucid"],
    "wis": ["resolute"],
    "cha": ["majestic"]
};
const dis_map = {
    "str": ["battered"],
    "dex": ["shaky"],
    "con": ["fevered"],
    "int": ["addled"],
    "wis": ["rattled"],
    "cha": ["stench"]
};
// Listen for changes to ANY status checkbox
const status_attrs = [
    "status_empowered", "status_weakened",
    "status_mighty", "status_battered",
    "status_nimble", "status_shaky",
    "status_vigorous", "status_fevered",
    "status_lucid", "status_addled",
    "status_resolute", "status_rattled",
    "status_majestic", "status_stench"
];
const status_listen_string = status_attrs.map(s => "change:" + s).join(" ");
on(status_listen_string, function() {
    getAttrs(status_attrs, function(values) {
        const empowered = values.status_empowered === "on";
        const weakened = values.status_weakened === "on";
        const update = {};
        stats.forEach(stat => {
            let isAdv = empowered;
            let isDis = weakened;
            // Check specific advantage
            if (adv_map[stat]) {
                adv_map[stat].forEach(cond => {
                    if (values["status_" + cond] === "on") isAdv = true;
                });
            }
            // Check specific disadvantage
            if (dis_map[stat]) {
                dis_map[stat].forEach(cond => {
                    if (values["status_" + cond] === "on") isDis = true;
                });
            }
            // Determine State
            let state = "normal";
            if (isAdv && !isDis) state = "adv";
            else if (!isAdv && isDis) state = "dis";
            else if (isAdv && isDis) state = "cancel"; // Blue (Normal)
            update[stat + "_state"] = state;
        });
        setAttrs(update);
    });
});
// WARD LOGIC
on("change:status_warded", function(eventInfo) {
    if (eventInfo.newValue === "on") {
        setAttrs({ ward_state: "active" });
    } else {
        setAttrs({ ward_state: "normal" });
    }
});
// MOVEMENT & INITIATIVE LOGIC
const move_status_attrs = [
    "status_hastened", "status_grappled", "status_stuck", 
    "status_paralyzed", "status_unconscious", "status_prone",
    "status_deafened", "status_vigilant", "status_flying",
    "status_unstoppable", "status_shrouded", "status_ethereal", "status_distracted",
    "status_stunned", "status_frightened", "status_bewildered"
];
const move_listen_string = move_status_attrs.map(s => "change:" + s).join(" ");
on(move_listen_string, function() {
    getAttrs(move_status_attrs, function(values) {
        const hastened = values.status_hastened === "on";
        const grappled = values.status_grappled === "on";
        const stuck = values.status_stuck === "on";
        const paralyzed = values.status_paralyzed === "on";
        const unconscious = values.status_unconscious === "on";
        const prone = values.status_prone === "on";
        const deafened = values.status_deafened === "on";
        const vigilant = values.status_vigilant === "on";
        const flying = values.status_flying === "on";
        const unstoppable = values.status_unstoppable === "on";
        const shrouded = values.status_shrouded === "on";
        const ethereal = values.status_ethereal === "on";
        const distracted = values.status_distracted === "on";
        const stunned = values.status_stunned === "on";
        const frightened = values.status_frightened === "on";
        const bewildered = values.status_bewildered === "on";
        
        let text = [];
        let state = "normal";
        
        // Movement Logic - Bad conditions
        if (grappled || stuck || paralyzed || unconscious || stunned) {
            state = "bad";
            if (grappled) text.push("GRAPPLED (Speed 0; Cannot Move)");
            if (stuck) text.push("STUCK (Cannot Move)");
            if (paralyzed) text.push("PARALYZED (Cannot Move/Act; Defense Auto-Fail)");
            if (unconscious) text.push("UNCONSCIOUS (Paralyzed; Unaware; Drops Items)");
            if (stunned) text.push("STUNNED (Lose Turn; Cannot Move/Act)");
        }
        
        if (distracted) {
            state = "bad";
            text.push("DISTRACTED (Move Only; No Actions)");
        }
        
        if (frightened) {
            state = "bad";
            text.push("FRIGHTENED (Disadv All; Must Flee Source)");
        }
        
        if (bewildered) {
            state = "bad";
            text.push("BEWILDERED (Roll 1d4 for Move Direction)");
        }
        
        if (prone) {
            state = "bad";
            text.push("PRONE (Melee vs You=Adv; Ranged vs You=Dis)");
        }
        
        // Good conditions
        if (hastened) {
            if (state !== "bad") state = "good";
            text.push("HASTENED (Extra Action; Double Speed)");
        }
        
        if (flying) {
            if (state !== "bad") state = "good";
            text.push("FLYING (Vertical Move; Immune Ground Melee)");
        }
        
        if (unstoppable) {
            if (state !== "bad") state = "good";
            text.push("UNSTOPPABLE (Immune Move/Control Restrictions)");
        }
        
        if (shrouded) {
            if (state !== "bad") state = "good";
            text.push("SHROUDED (Invisible; Untargetable)");
        }
        
        if (ethereal) {
            if (state !== "bad") state = "good";
            text.push("ETHEREAL (Phase Through; Immune Non-Magic Phys)");
        }
        
        // Initiative Logic
        if (deafened) {
            state = "bad";
            text.push("DEAFENED (Disadv Init; Immune Commands)");
        }
        
        if (vigilant) {
            text.push("VIGILANT (No Surprise; See Invisible)");
            if (state !== "bad") state = "good";
        }
        
        setAttrs({
            move_state: state,
            movement_status_text: text.join(", ")
        });
    });
});

// HP STATUS LOGIC (Regenerating)
on("change:status_regenerating change:status_bleeding change:status_exhausted", function() {
    getAttrs(["status_regenerating", "status_bleeding", "status_exhausted"], function(values) {
        const regenerating = values.status_regenerating === "on";
        const bleeding = values.status_bleeding === "on";
        const exhausted = values.status_exhausted === "on";
        let text = [];
        let state = "normal";
        
        if (regenerating) {
            state = "good";
            text.push("REGENERATING (Regain X HP/Turn)");
        }
        
        if (bleeding) {
            state = "bad";
            text.push("BLEEDING (Lose 1 HD of HP Each Round)");
        }
        
        if (exhausted) {
            state = "bad";
            text.push("EXHAUSTED (Disadv All Stats Till Rest)");
        }
        
        setAttrs({
            hp_state: state,
            hp_status_text: text.join(", ")
        });
    });
});

// ATTACK STATUS LOGIC (Blinded, Prone)
const attack_status_attrs = ["status_blinded", "status_prone", "status_paralyzed", "status_unconscious", "status_silenced", "status_charmed", "status_confused", "status_stunned"];
const attack_listen_string = attack_status_attrs.map(s => "change:" + s).join(" ");
on(attack_listen_string, function() {
    getAttrs(attack_status_attrs, function(values) {
        const blinded = values.status_blinded === "on";
        const prone = values.status_prone === "on";
        const paralyzed = values.status_paralyzed === "on";
        const unconscious = values.status_unconscious === "on";
        const silenced = values.status_silenced === "on";
        const charmed = values.status_charmed === "on";
        const confused = values.status_confused === "on";
        const stunned = values.status_stunned === "on";
        
        let text = [];
        let state = "normal";
        
        if (blinded) {
            state = "bad";
            text.push("BLINDED (Disadv Atk/Def; No Sight Spells)");
        }
        
        if (silenced) {
            state = "bad";
            text.push("SILENCED (Cannot Speak or Cast Spells)");
        }
        
        if (charmed) {
            state = "bad";
            text.push("CHARMED (Cannot Attack the Enemy)");
        }
        
        if (confused) {
            state = "bad";
            text.push("CONFUSED (Attack Random Nearby or Move to Nearest)");
        }
        
        if (stunned) {
            state = "bad";
            text.push("STUNNED (Cannot Attack)");
        }
        
        if (prone) {
            state = "bad";
            text.push("PRONE (Melee vs You=Adv; Ranged vs You=Dis)");
        }
        
        if (paralyzed || unconscious) {
            state = "bad";
            text.push("DEFENSE AUTO-FAIL");
        }
        
        setAttrs({
            attack_state: state,
            attack_status_text: text.join(", ")
        });
    });
});

// DOWNTIME FOCUS - Sync selected attribute to focus_target
on("change:focus_attr sheet:opened", function() {
    getAttrs(["focus_attr", "str", "dex", "con", "int", "wis", "cha"], function(values) {
        const selectedAttr = values.focus_attr || "int";
        const targetValue = parseInt(values[selectedAttr]) || 10;
        setAttrs({ focus_target: targetValue });
    });
});

// Also update when any attribute changes
on("change:str change:dex change:con change:int change:wis change:cha", function() {
    getAttrs(["focus_attr", "str", "dex", "con", "int", "wis", "cha"], function(values) {
        const selectedAttr = values.focus_attr || "int";
        const targetValue = parseInt(values[selectedAttr]) || 10;
        setAttrs({ focus_target: targetValue });
    });
});

// ==========================================
// MAGICAL SIDE EFFECTS (d100 TABLE)
// ==========================================
on("clicked:magic_side_effect", function() {
    getAttrs(["character_name"], function(values) {
        const charName = values.character_name || "Unknown";
        
        startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Magical Side Effects}} {{roll=[[1d100]]}}", function(results) {
            const roll = results.results.roll.result;
            let effect = "";
            
            if (roll === 1) {
                effect = "Roll your Starting HD and add it to your Max HP.";
            } else if (roll === 2) {
                effect = "Permanently increase a Random Attribute by +1.";
            } else if (roll === 3) {
                effect = "Gain Temporary HP equal to Spell Level × 5.";
            } else if (roll === 4) {
                effect = "Double the amount of Coins currently carried on your person.";
            } else if (roll === 5) {
                effect = "Heal HP and recover all Spells/Usage Dice as if you finished a Long Rest.";
            } else if (roll >= 6 && roll <= 30) {
                effect = "Nothing happens and, if using a scroll, it is destroyed.";
            } else if (roll >= 31 && roll <= 55) {
                effect = "Nothing happens but, if using a scroll, it is not destroyed.";
            } else if (roll >= 56 && roll <= 61) {
                effect = "Roll on the Wandering Monster table immediately.";
            } else if (roll >= 62 && roll <= 70) {
                effect = "Take 1 Damage per Spell Level (ignores Armor).";
            } else if (roll >= 71 && roll <= 73) {
                effect = "Movement is reduced to Close (5ft) until Long Rest.";
            } else if (roll >= 74 && roll <= 76) {
                effect = "Lose one random Prepared Spell until Long Rest.";
            } else if (roll >= 77 && roll <= 79) {
                effect = "Lose one Attunement/Item Slot until Long Rest. If holding an item in that slot, drop it.";
            } else if (roll >= 80 && roll <= 81) {
                effect = "One of your Armor Dice instantly Breaks. If you have no Armor Dice, take 1d6 damage per Spell Level.";
            } else if (roll >= 82 && roll <= 83) {
                effect = "Roll the Doom Die. If it triggers, consequences occur immediately.";
            } else if (roll >= 84 && roll <= 85) {
                effect = "You cannot benefit from Magical Healing or Buffs until Long Rest.";
            } else if (roll >= 86 && roll <= 88) {
                effect = "You and Nearby creatures take 1d6 Force Damage per Spell Level.";
            } else if (roll >= 89 && roll <= 91) {
                effect = "Disadvantage on ALL Attribute Tests until Long Rest.";
            } else if (roll >= 92 && roll <= 94) {
                effect = "Gain Permanent Vulnerability (×2 Damage) to a random type.";
            } else if (roll >= 95 && roll <= 97) {
                effect = "Roll CON Test. If you roll ABOVE score, CON is permanently reduced by 1.";
            } else if (roll === 98) {
                effect = "You are instantly knocked Out of Action. Roll on OofA table.";
            } else if (roll === 99) {
                effect = "Drop to 0 HP. All non-magical gear on your person is destroyed.";
            } else if (roll === 100 || roll === 0) {
                effect = "Random Attribute becomes 3. Permanent.";
            }
            
            finishRoll(results.rollId, {});
            
            // Post the effect as a separate message
            startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=Magical Side Effects Result}} {{description=" + effect + "}}", function(r2) {
                finishRoll(r2.rollId, {});
            });
        });
    });
});
// ==========================================
// WEALTH MANAGER
// ==========================================
on("clicked:wealth_earn clicked:wealth_spend clicked:wealth_deposit clicked:wealth_withdraw", function(eventInfo) {
    // Determine which button was clicked
    const action = eventInfo.triggerName.replace("clicked:wealth_", ""); 
    
    getAttrs(["character_name", "wealth_purse", "wealth_bank"], function(values) {
        const charName = values.character_name || "Character";
        let purse = parseInt(values.wealth_purse) || 0;
        let bank = parseInt(values.wealth_bank) || 0;
        
        // Set the Title based on the button
        let actionTitle = "UPDATE";
        if (action === "earn") actionTitle = "EARNINGS";
        if (action === "spend") actionTitle = "SPENDING";
        if (action === "deposit") actionTitle = "DEPOSIT";
        if (action === "withdraw") actionTitle = "WITHDRAWAL";

        // Ask for Amount. We use {{cost}} because your template renders it nicely in Gold.
        // We do NOT use {{roll}} or {{damage}}, so those ugly rows will not appear.
        startRoll("&{template:birdhack} {{character_name=" + charName + "}} {{name=" + actionTitle + "}} {{cost=[[?{Amount|0}]]}}", function(results) {
            const amount = results.results.cost.result;
            
            // Perform the Math
            if (action === "earn") purse += amount;
            if (action === "spend") purse -= amount;
            if (action === "deposit") { purse -= amount; bank += amount; }
            if (action === "withdraw") { bank -= amount; purse += amount; }

            // Save the new values
            setAttrs({
                wealth_purse: purse,
                wealth_bank: bank
            });
            
            // Done. No text updates needed because the Header tells the story.
            finishRoll(results.rollId, {});
        });
    });
});
</script>
